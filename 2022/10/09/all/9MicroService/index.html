

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="ggq">
  <meta name="keywords" content="。">
  
    <meta name="description" content="。">
<meta property="og:type" content="article">
<meta property="og:title" content="微服务">
<meta property="og:url" content="https://gouguoqiang.github.io/2022/10/09/all/9MicroService/index.html">
<meta property="og:site_name" content="ggq">
<meta property="og:description" content="。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="c:\Users\%E5%86%8D%E9%9A%BE%E4%B9%9F%E4%BC%9A%E8%BF%87\AppData\Roaming\Typora\typora-user-images\image-20220627093319551.png">
<meta property="og:image" content="g:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps11.jpg">
<meta property="og:image" content="g:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps12.jpg">
<meta property="og:image" content="g:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps13.jpg">
<meta property="og:image" content="g:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps14.jpg">
<meta property="og:image" content="g:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps15.jpg">
<meta property="og:image" content="g:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps16.jpg">
<meta property="og:image" content="g:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps17.jpg">
<meta property="og:image" content="g:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps18.jpg">
<meta property="og:image" content="g:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps19.jpg">
<meta property="og:image" content="g:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps20.jpg">
<meta property="og:image" content="https://gouguoqiang.github.io/assets%5C1592058451822.png">
<meta property="og:image" content="c:\Users\%E5%86%8D%E9%9A%BE%E4%B9%9F%E4%BC%9A%E8%BF%87\AppData\Roaming\Typora\typora-user-images\image-20220627103529460.png">
<meta property="og:image" content="c:\Users\%E5%86%8D%E9%9A%BE%E4%B9%9F%E4%BC%9A%E8%BF%87\AppData\Roaming\Typora\typora-user-images\image-20220628105208537.png">
<meta property="og:image" content="c:\Users\%E5%86%8D%E9%9A%BE%E4%B9%9F%E4%BC%9A%E8%BF%87\AppData\Roaming\Typora\typora-user-images\image-20220628110313825.png">
<meta property="og:image" content="c:\Users\%E5%86%8D%E9%9A%BE%E4%B9%9F%E4%BC%9A%E8%BF%87\AppData\Roaming\Typora\typora-user-images\image-20220628110532488.png">
<meta property="article:published_time" content="2022-10-09T03:36:23.000Z">
<meta property="article:modified_time" content="2022-10-09T13:57:51.033Z">
<meta property="article:author" content="ggq">
<meta property="article:tag" content="多线程">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="c:\Users\%E5%86%8D%E9%9A%BE%E4%B9%9F%E4%BC%9A%E8%BF%87\AppData\Roaming\Typora\typora-user-images\image-20220627093319551.png">
  
  
  
  <title>微服务 - ggq</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"gouguoqiang.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="微服务"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-10-09 11:36" pubdate>
          2022年10月9日 中午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          54k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          448 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">微服务</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="微服务架构"><a href="#微服务架构" class="headerlink" title="微服务架构"></a>微服务架构</h1><pre><code class="hljs">1. 服务组件化
1. 服务间交互采用restful 风格
1. 去中心化 :每个服务有自己的私有数据库持久化系统
1. 自动化部署:把应用拆分为一个一个独立的单个服务,方便自动化部署,测试,运维
</code></pre>
<p>1.传统集中式架构</p>
<p>​	开发速度快</p>
<p>​	并发能力差</p>
<p>​	代码耦合度高,维护困难</p>
<p>​	容错率低</p>
<p>2.垂直拆分</p>
<p>​	一个数据库,多个系统模块</p>
<p>​	拆分实现了流量分担,解决并发</p>
<p>​	可针对不同模块进行优化</p>
<p>​	方便水平扩展(集群化),负载均衡,容错率高</p>
<p>​	系统间相互独立,会有很多重复开发,影响开发效率</p>
<p>3.分布式服务</p>
<p>​	垂直应用越来越多,应用交互不可避免</p>
<p>​	系统间相互调用,调高代码复用和效率</p>
<p>​	系统间耦合度高,调用关系错综复杂,难以维护</p>
<p>​		服务提供方一旦产生变更,所有消费方都需要变更</p>
<p>4.面向服务架构(SOA)</p>
<p>​	中间增加一层ESB,用来连接各个服务结点,集成不同系统,不同协议的服务</p>
<p>​	做消息的转化解释和路由工作</p>
<p>​	ESB产品实现复杂,服务粒度较大,	ESB包含的功能如:负载均衡,流量控制</p>
<p>​		加密处理,服务监控,异常处理等等</p>
<p>​	集成整合所有服务,数据转换使运维,测试部署困难</p>
<p>​	所有服务通过一个通路通信,降低通信速度</p>
<p>​	通常松耦合 基于socket工作在会话层,自定义数据格式,速度快,效率高</p>
<p>5.微服务架构</p>
<p>​	基于TCP工作在应用层,规定了数据传输格式</p>
<p>​	服务粒度小,使用轻量级通信,通常是HTTP API </p>
<p>​	各服务可使用不同的编程语言实现,以及不同的数据存储技术</p>
<p>​	服务间相互独立</p>
<p>​	并保持最低限度的集中式管理</p>
<p>​	<img src="C:\Users\再难也会过\AppData\Roaming\Typora\typora-user-images\image-20220627093319551.png" srcset="/img/loading.gif" lazyload alt="image-20220627093319551"></p>
<hr>
<blockquote>
<p>网关给用户提供统一的方式接入微服务,在网关层处理所有的非业务功能,例如身份验证,监控,负载均衡,缓存,请求分片与管理,静态响应处理,服务端通过服务注册中心进行服务注册和管理</p>
</blockquote>
<h1 id="dubbo"><a href="#dubbo" class="headerlink" title="dubbo"></a>dubbo</h1><h2 id="1-今日内容"><a href="#1-今日内容" class="headerlink" title="1-今日内容"></a>1-今日内容</h2><p> 分布式系统中的相关概念</p>
<p>dubbo 概述</p>
<p>dubbo快速入门</p>
<p>dubbo的高级特性</p>
<h2 id="2-相关概念"><a href="#2-相关概念" class="headerlink" title="2-相关概念"></a><strong>2-相关概念</strong></h2><h3 id="2-1-互联网项目架构-特点"><a href="#2-1-互联网项目架构-特点" class="headerlink" title="2.1-互联网项目架构-特点"></a>2.1-互联网项目架构-特点</h3><p>互联网项目架构-特点</p>
<ol>
<li><p>用户多</p>
</li>
<li><p>流量大，并发高</p>
</li>
<li><p>海量数据</p>
</li>
<li><p>易受攻击</p>
</li>
<li><p>功能繁琐</p>
</li>
<li><p>变更快</p>
</li>
</ol>
<p><strong>传统项目和互联网项目的不同</strong></p>
<p>![1581310475046](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;1581310475046.png)</p>
<p><strong>用户体验</strong>：<br>    美观、功能、速度、稳定性</p>
<p><strong>衡量一个网站速度是否快:</strong><br>    打开一个新页面一瞬间完成;页面内跳转，-刹那间完成。<br>    根据佛经《僧衹律》记载:一 刹那者为-念,二十念为-瞬,二十瞬为-弹<br>    指，二十弹指为-罗预， 二十罗预为-须臾，一日一夜有三十须臾。</p>
<h3 id="2-2-互联网项目架构-目标"><a href="#2-2-互联网项目架构-目标" class="headerlink" title="2.2-互联网项目架构-目标"></a>2.2-互联网项目架构-目标</h3><p><strong>衡量网站的性能指标:</strong><br>    **响应时间:**指执行一个请求从开始到最后收到响应数据所花费的总体时间。<br>    **并发数:**指系统同时能处理的请求数量。<br>    <strong>并发连接数:</strong> 指的是客户端向服务器发起请求，并建立了TCP连接。每秒钟服务器连接的总TCP数量<br>    **请求数:**也称为QPS(Query Per Second)指每秒多少请求.<br>    **并发用户数:**单位时间内有多少用户<br>    **吞吐量:**指单位时间内系统能处理的请求数量。</p>
<pre><code class="hljs">●QPS: Query Per Second每秒查询数。
●TPS: Transactions Per Second每秒事务数。
●一个事务是指一 个客户机向服务器发送请求然后服务器做出反应的过程。客户机在发送请求时开始计时，收到服务器响应后结束
计时，以此来计算使用的时间和完成的事务个数。
●一个页面的一次访问，只会形成一 个TPS; 但-次页面请求，可能产生多次对服务器的请求，就会有多个QPS
  QPS&gt;=并发连接数&gt;= TPS
</code></pre>
<p><strong>大型互联网项目架构目标</strong>:</p>
<p>​	●**高性能:<strong>提供快速的访问体验。<br>​	●</strong>高可用:**网站服务- 可以正常访问</p>
<h3 id="2-3-集群和分布式"><a href="#2-3-集群和分布式" class="headerlink" title="2.3-集群和分布式"></a>2.3-集群和分布式</h3><p>集群和分布式，<br>●集群:很多“人”一起，干一样的事。<br>●一个业务模块，部署在多台服务器上。<br>●分布式:很多”人”一起，干不样的事。这些不一样的事， 合起来是一件大事。</p>
<p>![](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;集群和分布式-1581325224087.png)</p>
<h3 id="2-4-架构演进"><a href="#2-4-架构演进" class="headerlink" title="2.4-架构演进"></a>2.4-架构演进</h3><p><strong>单体架构：</strong></p>
<p><strong>优点:</strong><br>    简单:开发部署都很方便，小型项目首选<br><strong>缺点:</strong><br>●项目启动慢<br>●可靠性差</p>
<p>![1581313584459](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;1581313584459.png)</p>
<p><strong>垂直架构：</strong>垂直架构是指将单体架构中的多个模块拆分为多个独立的项目。形成多个独立的单体架构。</p>
<p><strong>单体架构存在的问题:</strong></p>
<ul>
<li><p>项目启动慢</p>
</li>
<li><p>可靠性差</p>
</li>
<li><p>可伸缩性差</p>
</li>
<li><p>扩展性和可维护性差</p>
</li>
<li><p>性能低</p>
</li>
</ul>
<p><strong>垂直架构存在的问题:</strong> 重复功能太多</p>
<p>![1581313910427](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;1581313910427.png)</p>
<p><strong>分布式架构：</strong>是指在垂直架构的基础上,将公共业务模块抽取出来,作为独立的服务供其他调用者消费，以实现服务的共享和重用。底层通过RPC（远程过程调用实现）<br>    <strong>RPC:</strong> Remote Procedure Call远程过程调用。有非常多的协议和技术来都实现了RPC的过程。比如: HTTP REST风格，Java RMI规范、WebService SOAP协议Hession等等。<br><strong>垂直架构存在的问题:</strong><br>    ●重复功能太多</p>
<p><strong>分布式架构存在的问题:</strong><br>​	●服务提供方- -旦产生变更,所有消费方都需要变更。</p>
<p>![](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;分布式架构.png)</p>
<p>**SOA: (Service- Oriented Architecture,面向服务的架构)**：是一个组件模型,它将应用程序的不同功能单元(称为服务)进行拆分，并通过这些服务之间定义良好的接口和契约联系起来。</p>
<p>**ESB: (Enterparise Servce Bus)**：企业服务总线,服务中介。主要是提供了一一个服<br>务于服务之间的交互。ESB包含的功能如:负载均衡，流量控制，加密处理，服务<br>的监控，异常处理，监控告急等等。</p>
<p>![1581314362523](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;1581314362523.png)</p>
<p><strong>微服务架构：</strong></p>
<p>●微服务架构是在SOA上做的升华,微服务架构强调的一个重点是“业务需要彻底的组件化和服务化”，原有的单个<br>业务系统会拆分为多个可以独立开发、设计、运行的小应用。这些小应用之间通过服务完成交互和集成。</p>
<p>●微服务架构&#x3D; 80%的SOA服务架构思想+ 100%的组件化架构思想+ 80%的领域建模思想</p>
<p><strong>特点:</strong><br>●服务实现组件化:开发者可以自由选择开发技术。也不需要协调其他团队<br>●服务之间交互一 般使用REST API<br>●去中心化:每个微服务有自己私有的数据库持久化业务数据<br>●自动化部署:把应用拆分成为一 个-个独立的单个服务,方便自动化部署、测试、运维</p>
<p>![](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;微服务架构图.png)</p>
<h2 id="3-dubbo-概述"><a href="#3-dubbo-概述" class="headerlink" title="3-dubbo 概述"></a>3-dubbo 概述</h2><p><strong>Dubbo概念</strong></p>
<p>●Dubbo是阿里巴巴公司开源的一个高性能、轻量级的Java RPC框架。<br>●致力于提供高性能和透明化的RPC远程服务调用方案,以及SOA服务治理方案。<br>●官网: htp:&#x2F;&#x2F;ubbo.apache.orgo</p>
<p>![](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;Dubbo架构图.png)</p>
<p>节点角色说明: .<br>●Provider: 暴露服务的服务提供方<br>●Container: 服务运行容器<br>●Consumer: 调用远程服务的服务消费方<br>●Registry: 服务注册与发现的注册中心<br>●Monitor:统计服务的调用次数和调用时间的监控中心</p>
<h2 id="4-dubbo快速入门"><a href="#4-dubbo快速入门" class="headerlink" title="4-dubbo快速入门"></a>4-dubbo快速入门</h2><h3 id="4-1zookeeper安装"><a href="#4-1zookeeper安装" class="headerlink" title="4.1zookeeper安装"></a>4.1zookeeper安装</h3><p>安装步骤：</p>
<p>第一步：安装 jdk（略）<br>第二步：把 zookeeper 的压缩包（zookeeper-3.4.6.tar.gz）上传到 linux 系统<br>第三步：解压缩压缩包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar -zxvf  zookeeper-3.4.6.tar.gz<br></code></pre></td></tr></table></figure>

<p>第四步：进入zookeeper-3.4.6目录，创建data目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">mkdir</span> data<br></code></pre></td></tr></table></figure>

<p>第五步：进入conf目录 ，把zoo_sample.cfg 改名为zoo.cfg</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> conf<br><span class="hljs-built_in">mv</span> zoo_sample.cfg zoo.cfg<br></code></pre></td></tr></table></figure>

<p>第六步：打开zoo.cfg文件,  修改data属性：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">dataDir=/root/zookeeper-3.4.6/data<br></code></pre></td></tr></table></figure>



<p>进入Zookeeper的bin目录，启动服务命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">./zkServer.sh start<br></code></pre></td></tr></table></figure>

<p>![1581315609244](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;1581315609244.png)</p>
<p>停止服务命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">./zkServer.sh stop<br></code></pre></td></tr></table></figure>



<p>查看服务状态：standalone 单节点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">./zkServer.sh status<br></code></pre></td></tr></table></figure>

<p>![1581315645227](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;1581315645227.png)</p>
<h3 id="4-2spring和springmvc整合"><a href="#4-2spring和springmvc整合" class="headerlink" title="4.2spring和springmvc整合"></a>4.2spring和springmvc整合</h3><p>实施步骤：</p>
<p>1.创建服务提供者Provider模块<br>2.创建服务消费者Consumer模块<br>3.在服务提供者模块编写UserServicelmpl提供服务<br>4.在服务消费者中的UserC ontroller远程调用<br>5.UserServicelmpl提供的服务<br>6.分别启动两个服务，测试</p>
<p>Dubbo作为一个RPC框架，其最核心的功能就是要实现跨网络的远程调用。本小节就是要创建两个应用，一个作为服务的提供方，一个作为服务的消费方。通过Dubbo来实现服务消费方远程调用服务提供方的方法。</p>
<p>1 服务提供方开发</p>
<p>开发步骤：</p>
<p>（1）创建maven工程（打包方式为war）dubbodemo_provider，在pom.xml文件中导入如下坐标</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">spring.version</span>&gt;</span>5.0.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-beans<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-webmvc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-aspects<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-jms<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context-support<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- dubbo相关 --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dubbo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.zookeeper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>zookeeper<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.sgroschupf<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>zkclient<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.12.1.GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.47<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 指定端口 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>8081<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 请求路径 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">path</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">path</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>（2）配置web.xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">web-app</span> <span class="hljs-keyword">PUBLIC</span></span><br><span class="hljs-meta"> <span class="hljs-string">&quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span></span><br><span class="hljs-meta"> <span class="hljs-string">&quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>Archetype Created Web Application<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>contextConfigLocation<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>classpath:applicationContext*.xml<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>（3）创建服务接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.service;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HelloService</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String name)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（4）创建服务实现类</p>
<p><strong>注意：</strong>服务实现类上使用的Service注解是Dubbo提供的，用于对外发布服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.service.impl;<br><span class="hljs-keyword">import</span> com.alibaba.dubbo.config.annotation.Service;<br><span class="hljs-keyword">import</span> com.itheima.service.HelloService;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HelloService</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<p>tomcat7:run</p>
<p>2 服务消费方开发</p>
<p>开发步骤：</p>
<p>（1）创建maven工程（打包方式为war）dubbodemo_consumer，pom.xml配置和上面服务提供者相同，只需要将Tomcat插件的端口号改为8082即可</p>
<p>（2）配置web.xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">web-app</span> <span class="hljs-keyword">PUBLIC</span></span><br><span class="hljs-meta"> <span class="hljs-string">&quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span></span><br><span class="hljs-meta"> <span class="hljs-string">&quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>Archetype Created Web Application<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>springmvc<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 指定加载的配置文件 ，通过参数contextConfigLocation加载 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>contextConfigLocation<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>classpath:applicationContext-web.xml<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">load-on-startup</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">load-on-startup</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>springmvc<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>*.do<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>（3）将服务提供者工程中的HelloService接口复制到当前工程</p>
<p>（4）编写Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.controller;<br><span class="hljs-keyword">import</span> com.alibaba.dubbo.config.annotation.Reference;<br><span class="hljs-keyword">import</span> com.itheima.service.HelloService;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/demo&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br>    <span class="hljs-meta">@Reference</span><br>    <span class="hljs-keyword">private</span> HelloService helloService;<br>    <span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-comment">//远程调用</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> helloService.sayHello(name);<br>        System.out.println(result);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意：Controller中注入HelloService使用的是Dubbo提供的@Reference注解</p>
<h3 id="4-3服务提供者"><a href="#4-3服务提供者" class="headerlink" title="4.3服务提供者"></a>4.3服务提供者</h3><p>在dubbodemo_provider工程中src&#x2F;main&#x2F;resources下创建applicationContext-service.xml </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">		<span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">	    <span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span></span><br><span class="hljs-tag">		<span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">		<span class="hljs-attr">xmlns:dubbo</span>=<span class="hljs-string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span><br><span class="hljs-tag">	    <span class="hljs-attr">xmlns:mvc</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span><br><span class="hljs-tag">		<span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">		http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">         http://www.springframework.org/schema/mvc</span></span><br><span class="hljs-string"><span class="hljs-tag">         http://www.springframework.org/schema/mvc/spring-mvc.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">         http://code.alibabatech.com/schema/dubbo</span></span><br><span class="hljs-string"><span class="hljs-tag">         http://code.alibabatech.com/schema/dubbo/dubbo.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">         http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">         http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br>	<span class="hljs-comment">&lt;!-- 当前应用名称，用于注册中心计算应用间依赖关系，注意：消费者和提供者应用名不要一样 --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:application</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dubbodemo_provider&quot;</span> /&gt;</span><br>	<span class="hljs-comment">&lt;!-- 连接服务注册中心zookeeper ip为zookeeper所在服务器的ip地址--&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;zookeeper://192.168.134.129:2181&quot;</span>/&gt;</span><br>	<span class="hljs-comment">&lt;!-- 注册  协议和port   端口默认是20880 --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:protocol</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dubbo&quot;</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;20881&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dubbo:protocol</span>&gt;</span><br>    <br>	<span class="hljs-comment">&lt;!-- 扫描指定包，加上@Service注解的类会被发布为服务  --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:annotation</span> <span class="hljs-attr">package</span>=<span class="hljs-string">&quot;com.itheima.service.impl&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h3 id="4-4服务消费者"><a href="#4-4服务消费者" class="headerlink" title="4.4服务消费者"></a>4.4服务消费者</h3><p>在dubbodemo_consumer工程中src&#x2F;main&#x2F;resources下创建applicationContext-web.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">	<span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">	<span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span></span><br><span class="hljs-tag">	<span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">	<span class="hljs-attr">xmlns:dubbo</span>=<span class="hljs-string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span><br><span class="hljs-tag">	<span class="hljs-attr">xmlns:mvc</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span><br><span class="hljs-tag">	<span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">			http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">			http://www.springframework.org/schema/mvc</span></span><br><span class="hljs-string"><span class="hljs-tag">			http://www.springframework.org/schema/mvc/spring-mvc.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">			http://code.alibabatech.com/schema/dubbo</span></span><br><span class="hljs-string"><span class="hljs-tag">			http://code.alibabatech.com/schema/dubbo/dubbo.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">			http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">			http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><br>	<span class="hljs-comment">&lt;!-- 当前应用名称，用于注册中心计算应用间依赖关系，注意：消费者和提供者应用名不要一样 --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:application</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dubbodemo-consumer&quot;</span> /&gt;</span><br>	<span class="hljs-comment">&lt;!-- 连接服务注册中心zookeeper ip为zookeeper所在服务器的ip地址--&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;zookeeper://192.168.134.129:2181&quot;</span>/&gt;</span><br>	<span class="hljs-comment">&lt;!-- 包扫描的方式 引用服务 扫描@Reference --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:annotation</span> <span class="hljs-attr">package</span>=<span class="hljs-string">&quot;com.itheima.controller&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>



<p>运行测试</p>
<p>tomcat7:run启动</p>
<p>在浏览器输入<a target="_blank" rel="noopener" href="http://localhost:8082/demo/hello.do?name=Jack%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BE%93%E5%87%BA%E7%BB%93%E6%9E%9C">http://localhost:8082/demo/hello.do?name=Jack，查看浏览器输出结果</a></p>
<h2 id="5-dubbo高级特性"><a href="#5-dubbo高级特性" class="headerlink" title="5-dubbo高级特性"></a>5-dubbo高级特性</h2><h3 id="5-1dubbo-admin安装"><a href="#5-1dubbo-admin安装" class="headerlink" title="5.1dubbo-admin安装"></a>5.1dubbo-admin安装</h3><p>dubbo- admin<br>    ●dubbo-admin管理平台，是图形化的服务管理页面<br>    ●从注册中心中获取到所有的提供者 &#x2F;消费者进行配置管理<br>    ●路由规则、动态配置、服务降级、访问控制、权重调整、负载均衡等管理功能<br>    ●dubbo- admin是一个前后端分离的项目。前端使用vue，后端使用springboot<br>    ●安装dubbo-admin其实就是部署该项目</p>
<p>具体安装参见：dubbo-admin.md</p>
<h3 id="5-2-dubbo-admin使用"><a href="#5-2-dubbo-admin使用" class="headerlink" title="5.2-dubbo-admin使用"></a>5.2-dubbo-admin使用</h3><p>具体安装参见：dubbo-admin.md</p>
<h3 id="5-3序列化"><a href="#5-3序列化" class="headerlink" title="5.3序列化"></a>5.3序列化</h3><ol>
<li>dubbo 内部已经将序列化和反序列化的过程内部封装了</li>
<li>我们只需要在定义pojo类时<strong>实现seriali zable接口</strong>即可</li>
<li>一般会定义一 个公共的pojo模块,让生产者和消费者都依赖该模块。</li>
</ol>
<p>![1581317650919](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;1581317650919.png)</p>
<p>User对象未实现seriali zable接口</p>
<p>错误信息：</p>
<p>![1581317583708](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;1581317583708.png)</p>
<p>解决办法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">User <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span><br></code></pre></td></tr></table></figure>



<h3 id="5-4地址缓存"><a href="#5-4地址缓存" class="headerlink" title="5.4地址缓存"></a>5.4地址缓存</h3><p><strong>注册中心挂了，服务是否可以正常访问？</strong></p>
<ol>
<li>可以，因为dubbo服务消费者在第一-次调用时，会将服务提供方地址缓存到本地，以后在调用则不会访问注册中心。</li>
<li>当服务提供者地址发生变化时，注册中心会通知服务消费者。</li>
</ol>
<p>![](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;Dubbo架构图-1581318103917.png)</p>
<h3 id="5-5-超时"><a href="#5-5-超时" class="headerlink" title="5.5 超时"></a>5.5 超时</h3><p>![](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;超时图片.png)</p>
<ul>
<li>服务消费者在调用服务提供者的时候发生了阻塞、等待的情形,这个时候,服务消费者会直等待下去。</li>
<li>在某个峰值时刻，大量的请求都在同时请求服务消费者,会造成线程的大量堆积，势必会造成雪崩。</li>
<li>dubbo利用超时机制来解决这个问题，设置-个超时时间, 在这个时间段内，无法完成服务访问,则自动断开连接。</li>
<li>使用timeout属性配置超时时间，默认值1000，单位毫秒</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//timeout 超时时间 单位毫秒  retries 重试次数</span><br><span class="hljs-meta">@Service(timeout = 3000,retries=0)</span><br></code></pre></td></tr></table></figure>



<h3 id="5-6重试"><a href="#5-6重试" class="headerlink" title="5.6重试"></a>5.6重试</h3><p>![1581322543136](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;1581322543136.png)</p>
<ol>
<li>设置了超时时间，在这个时间段内，无法完成服务访问,则自动断开连接。</li>
<li>如果出现网络抖动,则这一-次请求就会失败。</li>
<li>Dubbo提供重试机制来避免类似问题的发生。</li>
<li>通过retries属性来设置重试次数。默认为2次</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//timeout 超时时间 单位毫秒  retries 重试次数</span><br><span class="hljs-meta">@Service(timeout = 3000,retries=0)</span><br></code></pre></td></tr></table></figure>

<h3 id="5-7多版本"><a href="#5-7多版本" class="headerlink" title="5.7多版本"></a>5.7多版本</h3><p>![](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;多版本图片.png)</p>
<p>**灰度发布:**当出现新功能时,会让一部分用户先使用新功能，用户反馈没问题时，再将所有用户迁移到新功能。</p>
<p>dubbo中使用version属性来设置和调用同一个接口的不同版本</p>
<p>生产者配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service(version=&quot;v2.0&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImp12</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;...&#125;<br></code></pre></td></tr></table></figure>

<p>消费者配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Reference(version = &quot;v2.0&quot;)</span><span class="hljs-comment">//远程注入</span><br><span class="hljs-keyword">private</span> UserService userService;<br></code></pre></td></tr></table></figure>



<h3 id="5-8负载均衡"><a href="#5-8负载均衡" class="headerlink" title="5.8负载均衡"></a>5.8负载均衡</h3><p><strong>负载均衡策略(4种) :</strong><br>**Random:**按权重随机，默认值。按权重设置随机概率。</p>
<p><strong>RoundRobin:</strong> 按权重轮询。</p>
<p><strong>LeastActive:</strong> 最少活跃调用数,相同活跃数的随机。</p>
<p>**ConsistentHash:**一 致性Hash,相同参数的请求总是发到同一提供者。</p>
<p>![](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;负载均衡图.png)</p>
<p>服务提供者配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service(weight = 100)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImp12</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;...&#125;<br></code></pre></td></tr></table></figure>



<p>application.xml 配置parameter key</p>
<p>![](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;负载均衡-配置文件.png)</p>
<p>消费者配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//@Reference(loadbalance = &quot;roundrobin&quot;)</span><br><span class="hljs-comment">//@Reference(loadbalance = &quot;leastactive&quot;)</span><br><span class="hljs-comment">//@Reference(loadbalance = &quot;consistenthash&quot;)</span><br><span class="hljs-meta">@Reference(loadbalance = &quot;random&quot;)</span><span class="hljs-comment">//默认 按权重随机</span><br><span class="hljs-keyword">private</span> UserService userService;<br></code></pre></td></tr></table></figure>

<h3 id="5-9集群容错"><a href="#5-9集群容错" class="headerlink" title="5.9集群容错"></a>5.9集群容错</h3><p>![1581324308044](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;1581324308044.png)</p>
<p><strong>集群容错模式:</strong><br>    **Failover Cluster:**失败重试。默认值。当出现失败，重试其它服务器，默认重试2次，使用retries配置。一般用于读操作<br>    **Failfast Cluster :**快速失败,发起-次调用，失败立即报错。通常用于写操作。<br>    **Failsafe Cluster:**失败安全，出现异常时，直接忽略。返回一个空结果。<br>    **Failback Cluster:**失败自动恢复,后台记录失败请求,定时重发。<br>    **Forking Cluster :**并行调用多个服务器，只要一个成功即返回。<br>    <strong>Broadcast Cluster:</strong> 广播调用所有提供者,逐个调用，任意一台报错则报错。</p>
<p>消费者配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Reference(cluster = &quot;failover&quot;)</span><span class="hljs-comment">//远程注入</span><br><span class="hljs-keyword">private</span> UserService userService;<br></code></pre></td></tr></table></figure>

<h3 id="5-10服务降级"><a href="#5-10服务降级" class="headerlink" title="5.10服务降级"></a>5.10服务降级</h3><p><strong>服务降级</strong>：当服务器压力剧增的情况下，根据实际业务情况及流量，对一些服务和页面有策略的不处理或换种简单的方式处理，从而释放服务器资源以保证<strong>核心交易</strong>正常运作或高效运作</p>
<p><strong>服务降级方式:</strong><br><strong>mock&#x3D; force:return null</strong>：表示消费方对该服务的方法调用都直接返回null值,不发起远程调用。用来屏蔽不重要服务不可用时对调用方的影响。</p>
<p><strong>mock&#x3D;fail:return null</strong>：表示消费方对该服务的方法调用在失败后，再返回null值,不抛异常。用来容忍不重要服务不稳定时对调用方的影响</p>
<p>![](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;4.Dubbo【海量资源尽在 】&#x2F;20-Dubbo&#x2F;笔记&#x2F;img&#x2F;服务降级图片.png)</p>
<p>消费方配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//远程注入</span><br><span class="hljs-meta">@Reference(mock =“ force :return null&quot;)</span><span class="hljs-comment">//不再调用userService的服务</span><br><span class="hljs-keyword">private</span> UserService userService;<br></code></pre></td></tr></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>SOA,RPC框架 用Zookeeper作为注册中心 </p>
<h3 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h3><h3 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h3><p>提供者</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 当前应用名称，用于注册中心计算应用间依赖关系，注意：消费者和提供者应用名不要一样 --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:application</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dubbodemo_provider&quot;</span> /&gt;</span><br>	<span class="hljs-comment">&lt;!-- 连接服务注册中心zookeeper ip为zookeeper所在服务器的ip地址--&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;zookeeper://192.168.134.129:2181&quot;</span>/&gt;</span><br>	<span class="hljs-comment">&lt;!-- 注册  协议和port   端口默认是20880 --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:protocol</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dubbo&quot;</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;20881&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dubbo:protocol</span>&gt;</span><br>    <br>	<span class="hljs-comment">&lt;!-- 扫描指定包，加上@Service注解的类会被发布为服务  --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:annotation</span> <span class="hljs-attr">package</span>=<span class="hljs-string">&quot;com.itheima.service.impl&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>

<p>消费者</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:application</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dubbodemo-consumer&quot;</span> /&gt;</span><br>	<span class="hljs-comment">&lt;!-- 连接服务注册中心zookeeper ip为zookeeper所在服务器的ip地址--&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;zookeeper://192.168.134.129:2181&quot;</span>/&gt;</span><br>	<span class="hljs-comment">&lt;!-- 包扫描的方式 引用服务 扫描@Reference --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:annotation</span> <span class="hljs-attr">package</span>=<span class="hljs-string">&quot;com.itheima.controller&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="超时-重试-负载均衡-灰度发布-多版本"><a href="#超时-重试-负载均衡-灰度发布-多版本" class="headerlink" title="超时,重试,负载均衡,灰度发布(多版本)"></a>超时,重试,负载均衡,灰度发布(多版本)</h3><p>@Service(timeout &#x3D; ,retries &#x3D;  ,version&#x3D;””)  同spring @service一致采用dubbo包 用于服务发布</p>
<p>@Reference(loadbalance &#x3D; “”,version &#x3D; “”)) 类似Autowire 用于服务发现</p>
<p>&#x2F;&#x2F;@Reference(loadbalance &#x3D; “roundrobin”)<br>&#x2F;&#x2F;@Reference(loadbalance &#x3D; “leastactive”)<br>&#x2F;&#x2F;@Reference(loadbalance &#x3D; “consistenthash”)<br>@Reference(loadbalance &#x3D; “random”)&#x2F;&#x2F;默认 按权重随机</p>
<p>@Service(timeout &#x3D; 3000,retries&#x3D;0)</p>
<p>@Reference(version &#x3D; “v2.0”)&#x2F;&#x2F;远程注入</p>
<p>private UserService userService;</p>
<h3 id="集群容错"><a href="#集群容错" class="headerlink" title="集群容错"></a>集群容错</h3><p>**Failover Cluster:**失败重试。默认值。当出现失败，重试其它服务器，默认重试2次，使用retries配置。一般用于读操作<br>    **Failfast Cluster :**快速失败,发起-次调用，失败立即报错。通常用于写操作。<br>    **Failsafe Cluster:**失败安全，出现异常时，直接忽略。返回一个空结果。<br>    **Failback Cluster:**失败自动恢复,后台记录失败请求,定时重发。<br>    **Forking Cluster :**并行调用多个服务器，只要一个成功即返回。<br>    <strong>Broadcast Cluster:</strong> 广播调用所有提供者,逐个调用，任意一台报错则报错。</p>
<p>消费者配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Reference(cluster = &quot;failover&quot;)</span><span class="hljs-comment">//远程注入</span><br><span class="hljs-keyword">private</span> UserService userService;<br></code></pre></td></tr></table></figure>

<h3 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h3><p><strong>服务降级</strong>：当服务器压力剧增的情况下，根据实际业务情况及流量，对一些服务和页面有策略的不处理或换种简单的方式处理，从而释放服务器资源以保证<strong>核心交易</strong>正常运作或高效运作</p>
<p><strong>服务降级方式:</strong><br><strong>mock&#x3D; force:return null</strong>：表示消费方对该服务的方法调用都直接返回null值,不发起远程调用。用来屏蔽不重要服务不可用时对调用方的影响。</p>
<p><strong>mock&#x3D;fail:return null</strong>：表示消费方对该服务的方法调用在失败后，再返回null值,不抛异常。用来容忍不重要服务不稳定时对调用方的影响</p>
<p>消费方配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//远程注入</span><br><span class="hljs-meta">@Reference(mock =“ force :return null&quot;)</span><span class="hljs-comment">//不再调用userService的服务</span><br><span class="hljs-keyword">private</span> UserService userService;<br></code></pre></td></tr></table></figure>

<p>分布式 很多人一起干不一样的事 合起来是一件大事</p>
<p>0-5 共六步</p>
<blockquote>
<p>图片 todo</p>
</blockquote>
<h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><ol>
<li><p>一个RPC框架 远程过程调用,能够将单体上的应用的各个模块变成分布式,关键是call过程,通过zookeeper注册中心(服务治理)</p>
<ol>
<li><p>zookeepper 是一个树结构,结点可以存储信息 &#x2F; 根节点 </p>
<ol>
<li><p>分布式锁的实现</p>
<ol>
<li><p>临时有序结点,选取顺序最小的 每个线程申请都会生成一结点,</p>
<ol start="2">
<li>集群治理<ol start="3">
<li>其他高级特性<br>       心跳<br>         负载均衡<br>         容灾<br>         服务注册&#x2F;发现<br><br><br>4. 配置管理</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>服务提供者将服务信息注册到服务中心,消费者对生产者进行调用,会在本地存有地址和端口缓存,如果服务提供者的地址端口信息等进行更新,zookeepper会通知消费者更新缓存</p>
<ol>
<li>(在下次调用时更新还是一更改就更新?思考:一更改就更新,会有缓存的嗅探()好处是只要缓存命中就能保证服务的可靠性,如果调用时更新,缓存的意义就不大了,)</li>
</ol>
<p>还有 monitor (sentinel(或duboo-admin)对rpc进行监控)</p>
</li>
</ol>
<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ol>
<li><p>序列化</p>
</li>
<li><p>地址缓存</p>
</li>
<li><p>超时与重试</p>
<ol>
<li>消费者的请求阻塞,等待的时候,dubbo设置了超时机制,无法完成服务访问则自动断开连接(基于TCP的连接?)</li>
<li>如果出现网络抖动,请求失败,通过retries设置重传次数 默认2</li>
</ol>
</li>
<li><p>多版本</p>
<ol>
<li>用version属性来调用同一个接口的不同版本</li>
</ol>
</li>
<li><p>负载均衡选用哪个服务</p>
<ol>
<li>random :按权重随机,每个默认都为100</li>
<li>roundRobin权重轮询</li>
<li>LeastActive最少活跃调用,相同活跃随机</li>
<li>ConsistentHash 一致性hash,相同参数的请求总是发到同一提供者</li>
</ol>
<p>6)集群容错</p>
</li>
</ol>
<h2 id="实验1-通过Dubbo实现远程调用"><a href="#实验1-通过Dubbo实现远程调用" class="headerlink" title="实验1 通过Dubbo实现远程调用"></a>实验1 通过Dubbo实现远程调用</h2><p>启动 zookeepper</p>
<p>生产者 编写service 在Impl上增加dubbo service注解 用于对外发布服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HelloService</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello &quot;</span> + name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 当前应用名称，用于注册中心计算应用间依赖关系，注意：消费者和提供者应用名不要一样 --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:application</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dubbodemo_provider&quot;</span> /&gt;</span><br>	<span class="hljs-comment">&lt;!-- 连接服务注册中心zookeeper ip为zookeeper所在服务器的ip地址--&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;zookeeper://192.168.134.129:2181&quot;</span>/&gt;</span><br>	<span class="hljs-comment">&lt;!-- 注册  协议和port   端口默认是20880 --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:protocol</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dubbo&quot;</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;20881&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dubbo:protocol</span>&gt;</span><br>    <br>	<span class="hljs-comment">&lt;!-- 扫描指定包，加上@Service注解的类会被发布为服务  --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:annotation</span> <span class="hljs-attr">package</span>=<span class="hljs-string">&quot;com.itheima.service.impl&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>



<p>消费者编写 controller 远程调用 service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.controller;<br><span class="hljs-keyword">import</span> com.alibaba.dubbo.config.annotation.Reference;<br><span class="hljs-keyword">import</span> com.itheima.service.HelloService;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/demo&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br>    <span class="hljs-meta">@Reference</span><br>    <span class="hljs-keyword">private</span> HelloService helloService;<br>    <span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-comment">//远程调用</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> helloService.sayHello(name);<br>        System.out.println(result);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 当前应用名称，用于注册中心计算应用间依赖关系，注意：消费者和提供者应用名不要一样 --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:application</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dubbodemo-consumer&quot;</span> /&gt;</span><br>	<span class="hljs-comment">&lt;!-- 连接服务注册中心zookeeper ip为zookeeper所在服务器的ip地址--&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;zookeeper://192.168.134.129:2181&quot;</span>/&gt;</span><br>	<span class="hljs-comment">&lt;!-- 包扫描的方式 引用服务 扫描@Reference --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:annotation</span> <span class="hljs-attr">package</span>=<span class="hljs-string">&quot;com.itheima.controller&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>





<h1 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h1><h2 id="1-初识-Zookeeper"><a href="#1-初识-Zookeeper" class="headerlink" title="1)初识 Zookeeper"></a>1)初识 Zookeeper</h2><h3 id="1-1-Zookeeper概念"><a href="#1-1-Zookeeper概念" class="headerlink" title="1.1)Zookeeper概念"></a>1.1)Zookeeper概念</h3><p>•Zookeeper 是 Apache Hadoop 项目下的一个子项目，是一个树形目录服务。</p>
<p>•Zookeeper 翻译过来就是 动物园管理员，他是用来管 Hadoop（大象）、Hive(蜜蜂)、Pig(小 猪)的管理员。简称zk</p>
<p>•Zookeeper 是一个分布式的、开源的分布式应用程序的协调服务。</p>
<p>•Zookeeper 提供的主要功能包括：</p>
<p>•配置管理</p>
<p>•分布式锁</p>
<p>•集群管理</p>
<p>![1592054580488](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1592054580488.png)</p>
<p>![1592054603167](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1592054603167.png)</p>
<h2 id="2-ZooKeeper-安装与配置"><a href="#2-ZooKeeper-安装与配置" class="headerlink" title="2)ZooKeeper 安装与配置"></a>2)ZooKeeper 安装与配置</h2><h3 id="2-1-下载安装"><a href="#2-1-下载安装" class="headerlink" title="2.1) 下载安装"></a>2.1) 下载安装</h3><h4 id="2-1-1、环境准备"><a href="#2-1-1、环境准备" class="headerlink" title="2.1.1、环境准备"></a><strong>2.1.1、环境准备</strong></h4><p>ZooKeeper服务器是用Java创建的，它运行在JVM之上。需要安装JDK 7或更高版本。</p>
<h4 id="2-1-2、上传"><a href="#2-1-2、上传" class="headerlink" title="2.1.2、上传"></a><strong>2.1.2、上传</strong></h4><p>将下载的ZooKeeper放到&#x2F;opt&#x2F;ZooKeeper目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">上传zookeeper alt+p</span><br>put f:/setup/apache-zookeeper-3.5.6-bin.tar.gz<br><span class="hljs-meta prompt_">#</span><span class="language-bash">打开 opt目录</span><br>cd /opt<br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建zooKeeper目录</span><br>mkdir  zooKeeper<br><span class="hljs-meta prompt_">#</span><span class="language-bash">将zookeeper安装包移动到 /opt/zooKeeper</span><br>mv apache-zookeeper-3.5.6-bin.tar.gz /opt/zookeeper/<br></code></pre></td></tr></table></figure>

<h4 id="2-1-3、解压"><a href="#2-1-3、解压" class="headerlink" title="2.1.3、解压"></a><strong>2.1.3、解压</strong></h4><p>将tar包解压到&#x2F;opt&#x2F;zookeeper目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tar -zxvf apache-ZooKeeper-3.5.6-bin.tar.gz <br></code></pre></td></tr></table></figure>

<h3 id="2-2-配置启动"><a href="#2-2-配置启动" class="headerlink" title="2.2) 配置启动"></a>2.2) 配置启动</h3><h4 id="2-2-1、配置zoo-cfg"><a href="#2-2-1、配置zoo-cfg" class="headerlink" title="2.2.1、配置zoo.cfg"></a><strong>2.2.1、配置zoo.cfg</strong></h4><p>进入到conf目录拷贝一个zoo_sample.cfg并完成配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">进入到conf目录</span><br>cd /opt/zooKeeper/apache-zooKeeper-3.5.6-bin/conf/<br><span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝</span><br>cp  zoo_sample.cfg  zoo.cfg<br></code></pre></td></tr></table></figure>



<p>修改zoo.cfg</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">打开目录</span><br>cd /opt/zooKeeper/<br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建zooKeeper存储目录</span><br>mkdir  zkdata<br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改zoo.cfg</span><br>vim /opt/zooKeeper/apache-zooKeeper-3.5.6-bin/conf/zoo.cfg<br></code></pre></td></tr></table></figure>

<p>![1577548250377](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1577548250377.png)</p>
<p>修改存储目录：dataDir&#x3D;&#x2F;opt&#x2F;zookeeper&#x2F;zkdata</p>
<h4 id="2-2-2、启动ZooKeeper"><a href="#2-2-2、启动ZooKeeper" class="headerlink" title="2.2.2、启动ZooKeeper"></a><strong>2.2.2、启动ZooKeeper</strong></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /opt/zooKeeper/apache-zooKeeper-3.5.6-bin/bin/<br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动</span><br> ./zkServer.sh  start<br></code></pre></td></tr></table></figure>

<p>![1577548052037](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1577548052037.png)</p>
<p>看到上图表示ZooKeeper成功启动</p>
<p><strong>3、查看ZooKeeper状态</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./zkServer.sh status<br></code></pre></td></tr></table></figure>

<p>zookeeper启动成功。standalone代表zk没有搭建集群，现在是单节点</p>
<p>![1577548175232](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1577548175232.png)</p>
<p>zookeeper没有启动</p>
<p>![1577548112773](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1577548112773.png)</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h2 id="3-ZooKeeper-命令操作"><a href="#3-ZooKeeper-命令操作" class="headerlink" title="3)ZooKeeper 命令操作"></a>3)ZooKeeper 命令操作</h2><h3 id="3-1-Zookeeper命令操作数据模型"><a href="#3-1-Zookeeper命令操作数据模型" class="headerlink" title="3.1)Zookeeper命令操作数据模型"></a>3.1)Zookeeper命令操作数据模型</h3><p>•ZooKeeper 是一个树形目录服务,其数据模型和Unix的文件系统目录树很类似，拥有一个层次化结构。</p>
<p>•这里面的每一个节点都被称为： ZNode，每个节点上都会保存自己的数据和节点信息。 </p>
<p>• 节点可以拥有子节点，同时也允许少量（1MB）数据存储在该节点之下。</p>
<p>•节点可以分为四大类：</p>
<p>•PERSISTENT 持久化节点 </p>
<p>•EPHEMERAL 临时节点 ：-e</p>
<p>•PERSISTENT_SEQUENTIAL 持久化顺序节点 ：-s</p>
<p>•EPHEMERAL_SEQUENTIAL 临时顺序节点  ：-es</p>
<p>![1592054828485](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1592054828485.png)</p>
<p>![1592054844023](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1592054844023.png)</p>
<h3 id="3-2-Zookeeper命令操作服务端命令"><a href="#3-2-Zookeeper命令操作服务端命令" class="headerlink" title="3.2)Zookeeper命令操作服务端命令"></a><strong>3.2)Zookeeper命令操作服务端命令</strong></h3><p>•启动 ZooKeeper 服务: .&#x2F;zkServer.sh start</p>
<p>•查看 ZooKeeper 服务状态: .&#x2F;zkServer.sh status</p>
<p>•停止 ZooKeeper 服务: .&#x2F;zkServer.sh stop </p>
<p>•重启 ZooKeeper 服务: .&#x2F;zkServer.sh restart </p>
<p>![1592055088686](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1592055088686.png)</p>
<h3 id="3-3-Zookeeper客户端常用命令"><a href="#3-3-Zookeeper客户端常用命令" class="headerlink" title="3.3)Zookeeper客户端常用命令"></a><strong>3.3)Zookeeper客户端常用命令</strong></h3><p>•连接ZooKeeper服务端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./zkCli.sh –server ip:port<br></code></pre></td></tr></table></figure>

<p>•断开连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">quit<br></code></pre></td></tr></table></figure>

<p>•查看命令帮助</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">help<br></code></pre></td></tr></table></figure>

<p>•显示指定目录下节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> 目录<br></code></pre></td></tr></table></figure>

<p>•创建节点</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">create</span> /节点<span class="hljs-built_in">path</span> value<br></code></pre></td></tr></table></figure>

<p>•获取节点值</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">get</span> /节点<span class="hljs-type">path</span><br></code></pre></td></tr></table></figure>

<p>•设置节点值</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos"><span class="hljs-built_in">set</span> /节点<span class="hljs-built_in">path</span> value<br></code></pre></td></tr></table></figure>

<p>•删除单个节点</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">delete</span> /节点<span class="hljs-keyword">path</span><br></code></pre></td></tr></table></figure>

<p>•删除带有子节点的节点</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos">deleteall /节点<span class="hljs-built_in">path</span><br></code></pre></td></tr></table></figure>

<p>![1592055332198](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1592055332198.png)</p>
<p>![1592055345400](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1592055345400.png)</p>
<h3 id="3-4-客户端命令-创建临时有序节点"><a href="#3-4-客户端命令-创建临时有序节点" class="headerlink" title="3.4)客户端命令-创建临时有序节点"></a>3.4)客户端命令-创建临时有序节点</h3><p>•创建临时节点</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">create</span> -<span class="hljs-built_in">e</span> /节点<span class="hljs-keyword">path</span> <span class="hljs-keyword">value</span><br></code></pre></td></tr></table></figure>

<p>•创建顺序节点</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">create</span> -s /节点<span class="hljs-built_in">path</span> value<br></code></pre></td></tr></table></figure>

<p>•查询节点详细信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> –s /节点path <br></code></pre></td></tr></table></figure>

<p>•czxid：节点被创建的事务ID </p>
<p>•ctime: 创建时间 </p>
<p>•mzxid: 最后一次被更新的事务ID </p>
<p>•mtime: 修改时间 </p>
<p>•pzxid：子节点列表最后一次被更新的事务ID</p>
<p>•cversion：子节点的版本号 </p>
<p>•dataversion：数据版本号 </p>
<p>•aclversion：权限版本号 </p>
<p>•ephemeralOwner：用于临时节点，代表临时节点的事务ID，如果为持久节点则为0 </p>
<p>•dataLength：节点存储的数据的长度 </p>
<p>•numChildren：当前节点的子节点个数 </p>
<p>![1592055462588](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1592055462588.png)</p>
<h2 id="4-ZooKeeper-JavaAPI-操作"><a href="#4-ZooKeeper-JavaAPI-操作" class="headerlink" title="4)ZooKeeper JavaAPI 操作"></a>4)ZooKeeper JavaAPI 操作</h2><h3 id="4-1-urator介绍"><a href="#4-1-urator介绍" class="headerlink" title="4.1)urator介绍"></a>4.1)urator介绍</h3><p>•Curator 是 Apache ZooKeeper 的Java客户端库。</p>
<p>•常见的ZooKeeper Java API ：</p>
<p>•原生Java API</p>
<p>•ZkClient</p>
<p>•Curator</p>
<p>•Curator 项目的目标是简化 ZooKeeper 客户端的使用。</p>
<p>•Curator 最初是 Netfix 研发的,后来捐献了 Apache 基金会,目前是 Apache 的顶级项目。</p>
<p>•官网：<a target="_blank" rel="noopener" href="http://curator.apache.org/">http://curator.apache.org/</a></p>
<h3 id="4-2-JavaAPI操作建立连接"><a href="#4-2-JavaAPI操作建立连接" class="headerlink" title="4.2)JavaAPI操作建立连接"></a>4.2)JavaAPI操作建立连接</h3><p>1，搭建项目</p>
<p>创建项目curator-zk</p>
<p>引入pom和日志文件</p>
<p>资料文件夹下pom.xml和log4j.properties</p>
<p>![1592055569716](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1592055569716.png)</p>
<p>2、创建测试类，使用curator连接zookeeper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Before</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testConnect</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//重试策略</span><br>    <span class="hljs-type">RetryPolicy</span> <span class="hljs-variable">retryPolicy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExponentialBackoffRetry</span>(<span class="hljs-number">3000</span>, <span class="hljs-number">10</span>);<br>    <span class="hljs-comment">//2.第二种方式</span><br>    <span class="hljs-comment">//CuratorFrameworkFactory.builder();</span><br>    client = CuratorFrameworkFactory.builder()<br>        .connectString(<span class="hljs-string">&quot;192.168.200.130:2181&quot;</span>)<br>        .sessionTimeoutMs(<span class="hljs-number">60</span> * <span class="hljs-number">1000</span>)<br>        .connectionTimeoutMs(<span class="hljs-number">15</span> * <span class="hljs-number">1000</span>)<br>        .retryPolicy(retryPolicy)<br>        .namespace(<span class="hljs-string">&quot;itheima&quot;</span>)<br>        .build();<br>    <span class="hljs-comment">//开启连接</span><br>    client.start();<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-3-Zookeeper-JavaAPI操作-创建节点"><a href="#4-3-Zookeeper-JavaAPI操作-创建节点" class="headerlink" title="4.3)Zookeeper JavaAPI操作-创建节点"></a>4.3)Zookeeper JavaAPI操作-创建节点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 创建节点：create 持久 临时 顺序 数据</span><br><span class="hljs-comment">* 1. 基本创建 ：create().forPath(&quot;&quot;)</span><br><span class="hljs-comment">* 2. 创建节点 带有数据:create().forPath(&quot;&quot;,data)</span><br><span class="hljs-comment">* 3. 设置节点的类型：create().withMode().forPath(&quot;&quot;,data)</span><br><span class="hljs-comment">* 4. 创建多级节点  /app1/p1 ：create().creatingParentsIfNeeded().forPath(&quot;&quot;,data)</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreate</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//2. 创建节点 带有数据</span><br>    <span class="hljs-comment">//如果创建节点，没有指定数据，则默认将当前客户端的ip作为数据存储</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> client.create().forPath(<span class="hljs-string">&quot;/app2&quot;</span>, <span class="hljs-string">&quot;hehe&quot;</span>.getBytes());<br>    System.out.println(path);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreate2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//1. 基本创建</span><br>    <span class="hljs-comment">//如果创建节点，没有指定数据，则默认将当前客户端的ip作为数据存储</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> client.create().forPath(<span class="hljs-string">&quot;/app1&quot;</span>);<br>    System.out.println(path);<br>&#125;<br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreate3</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//3. 设置节点的类型</span><br>    <span class="hljs-comment">//默认类型：持久化</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> client.create().withMode(CreateMode.EPHEMERAL).forPath(<span class="hljs-string">&quot;/app3&quot;</span>);<br>    System.out.println(path);<br>&#125;<br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreate4</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//4. 创建多级节点  /app1/p1</span><br>    <span class="hljs-comment">//creatingParentsIfNeeded():如果父节点不存在，则创建父节点</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> client.create().creatingParentsIfNeeded().forPath(<span class="hljs-string">&quot;/app4/p1&quot;</span>);<br>    System.out.println(path);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-4-ZookeeperJavaAPI操作-查询节点"><a href="#4-4-ZookeeperJavaAPI操作-查询节点" class="headerlink" title="4.4)ZookeeperJavaAPI操作-查询节点"></a>4.4)ZookeeperJavaAPI操作-查询节点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 查询节点：</span><br><span class="hljs-comment">* 1. 查询数据：get: getData().forPath()</span><br><span class="hljs-comment">* 2. 查询子节点： ls: getChildren().forPath()</span><br><span class="hljs-comment">* 3. 查询节点状态信息：ls -s:getData().storingStatIn(状态对象).forPath()</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGet1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//1. 查询数据：get</span><br>    <span class="hljs-type">byte</span>[] data = client.getData().forPath(<span class="hljs-string">&quot;/app1&quot;</span>);<br>    System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(data));<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGet2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 2. 查询子节点： ls</span><br>    List&lt;String&gt; path = client.getChildren().forPath(<span class="hljs-string">&quot;/&quot;</span>);<br>    System.out.println(path);<br>&#125;<br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGet3</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">Stat</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stat</span>();<br>    System.out.println(status);<br>    <span class="hljs-comment">//3. 查询节点状态信息：ls -s</span><br>    client.getData().storingStatIn(status).forPath(<span class="hljs-string">&quot;/app1&quot;</span>);<br>    System.out.println(status);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-5-Zookeeper-JavaAPI操作-修改节点"><a href="#4-5-Zookeeper-JavaAPI操作-修改节点" class="headerlink" title="4.5)Zookeeper JavaAPI操作-修改节点"></a>4.5)Zookeeper JavaAPI操作-修改节点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 修改数据</span><br><span class="hljs-comment">* 1. 基本修改数据：setData().forPath()</span><br><span class="hljs-comment">* 2. 根据版本修改: setData().withVersion().forPath()</span><br><span class="hljs-comment">* * version 是通过查询出来的。目的就是为了让其他客户端或者线程不干扰我。</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">* <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>	client.setData().forPath(<span class="hljs-string">&quot;/app1&quot;</span>, <span class="hljs-string">&quot;itcast&quot;</span>.getBytes());<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSetForVersion</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">Stat</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stat</span>();<br>    <span class="hljs-comment">//3. 查询节点状态信息：ls -s</span><br>    client.getData().storingStatIn(status).forPath(<span class="hljs-string">&quot;/app1&quot;</span>);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> status.getVersion();<span class="hljs-comment">//查询出来的 3</span><br>    System.out.println(version);<br>    client.setData().withVersion(version).forPath(<span class="hljs-string">&quot;/app1&quot;</span>, <span class="hljs-string">&quot;hehe&quot;</span>.getBytes());<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-6-Zookeeper-JavaAPI操作-删除节点"><a href="#4-6-Zookeeper-JavaAPI操作-删除节点" class="headerlink" title="4.6)Zookeeper JavaAPI操作-删除节点"></a>4.6)Zookeeper JavaAPI操作-删除节点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 删除节点： delete deleteall</span><br><span class="hljs-comment">* 1. 删除单个节点:delete().forPath(&quot;/app1&quot;);</span><br><span class="hljs-comment">* 2. 删除带有子节点的节点:delete().deletingChildrenIfNeeded().forPath(&quot;/app1&quot;);</span><br><span class="hljs-comment">* 3. 必须成功的删除:为了防止网络抖动。本质就是重试。  client.delete().guaranteed().forPath(&quot;/app2&quot;);</span><br><span class="hljs-comment">* 4. 回调：inBackground</span><br><span class="hljs-comment">* <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDelete</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 1. 删除单个节点</span><br>    client.delete().forPath(<span class="hljs-string">&quot;/app1&quot;</span>);<br>&#125;<br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDelete2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//2. 删除带有子节点的节点</span><br>    client.delete().deletingChildrenIfNeeded().forPath(<span class="hljs-string">&quot;/app4&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDelete3</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//3. 必须成功的删除</span><br>    client.delete().guaranteed().forPath(<span class="hljs-string">&quot;/app2&quot;</span>);<br>&#125;<br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDelete4</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//4. 回调</span><br>    client.delete().guaranteed().inBackground(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BackgroundCallback</span>()&#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processResult</span><span class="hljs-params">(CuratorFramework client, CuratorEvent event)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            System.out.println(<span class="hljs-string">&quot;我被删除了~&quot;</span>);<br>            System.out.println(event);<br>        &#125;<br>    &#125;).forPath(<span class="hljs-string">&quot;/app1&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-7-Zookeeper-JavaAPI操作-Watch监听概述"><a href="#4-7-Zookeeper-JavaAPI操作-Watch监听概述" class="headerlink" title="4.7)Zookeeper JavaAPI操作-Watch监听概述"></a>4.7)Zookeeper JavaAPI操作-Watch监听概述</h3><p>•ZooKeeper 允许用户在指定节点上注册一些Watcher，并且在一些特定事件触发的时候，ZooKeeper 服务端会将事件通知到感兴趣的客户端上去，该机制是 ZooKeeper 实现分布式协调服务的重要特性。</p>
<p>•ZooKeeper 中引入了Watcher机制来实现了发布&#x2F;订阅功能能，能够让多个订阅者同时监听某一个对象，当一个对象自身状态变化时，会通知所有订阅者。</p>
<p>•ZooKeeper 原生支持通过注册Watcher来进行事件监听，但是其使用并不是特别方便</p>
<p>​    需要开发人员自己反复注册Watcher，比较繁琐。</p>
<p>•Curator引入了 Cache 来实现对 ZooKeeper 服务端事件的监听。</p>
<p>•ZooKeeper提供了三种Watcher：</p>
<p>•NodeCache : 只是监听某一个特定的节点</p>
<p>•PathChildrenCache : 监控一个ZNode的子节点. </p>
<p>•TreeCache : 可以监控整个树上的所有节点，类似于PathChildrenCache和NodeCache的组合</p>
<p>![1592057429708](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1592057429708.png)</p>
<h3 id="4-8Zookeeper-JavaAPI操作-Watch监听-NodeCache"><a href="#4-8Zookeeper-JavaAPI操作-Watch监听-NodeCache" class="headerlink" title="4.8Zookeeper JavaAPI操作-Watch监听-NodeCache"></a>4.8Zookeeper JavaAPI操作-Watch监听-NodeCache</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 演示 NodeCache：给指定一个节点注册监听器</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testNodeCache</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//1. 创建NodeCache对象</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">NodeCache</span> <span class="hljs-variable">nodeCache</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeCache</span>(client,<span class="hljs-string">&quot;/app1&quot;</span>);<br>    <span class="hljs-comment">//2. 注册监听</span><br>   	nodeCache.getListenable().addListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeCacheListener</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nodeChanged</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            System.out.println(<span class="hljs-string">&quot;节点变化了~&quot;</span>);<br>            <span class="hljs-comment">//获取修改节点后的数据</span><br>            <span class="hljs-type">byte</span>[] data = nodeCache.getCurrentData().getData();<br>            System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(data));<br>            &#125;<br>        &#125;);<br>    	<span class="hljs-comment">//3. 开启监听.如果设置为true，则开启监听是，加载缓冲数据</span><br>    	nodeCache.start(<span class="hljs-literal">true</span>);<br>    	<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-9-Zookeeper-JavaAPI操作-Watch监听-PathChildrenCache"><a href="#4-9-Zookeeper-JavaAPI操作-Watch监听-PathChildrenCache" class="headerlink" title="4.9)Zookeeper JavaAPI操作-Watch监听-PathChildrenCache"></a><strong>4.9)Zookeeper</strong> JavaAPI操作-Watch监听-PathChildrenCache</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPathChildrenCache</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//1.创建监听对象</span><br>    <span class="hljs-type">PathChildrenCache</span> <span class="hljs-variable">pathChildrenCache</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PathChildrenCache</span>(client,<span class="hljs-string">&quot;/app2&quot;</span>,<span class="hljs-literal">true</span>);<br>    <span class="hljs-comment">//2. 绑定监听器</span><br>    pathChildrenCache.getListenable().addListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PathChildrenCacheListener</span>() &#123;    			<span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">childEvent</span><span class="hljs-params">(CuratorFramework client, PathChildrenCacheEvent event)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            System.out.println(<span class="hljs-string">&quot;子节点变化了~&quot;</span>);<br>            System.out.println(event);<br>            <span class="hljs-comment">//监听子节点的数据变更，并且拿到变更后的数据</span><br>            <span class="hljs-comment">//1.获取类型</span><br>            PathChildrenCacheEvent.<span class="hljs-type">Type</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> event.getType();<br>            <span class="hljs-comment">//2.判断类型是否是update</span><br>            <span class="hljs-keyword">if</span>(type.equals(PathChildrenCacheEvent.Type.CHILD_UPDATED))&#123;<br>                System.out.println(<span class="hljs-string">&quot;数据变了！！！&quot;</span>);<br>                <span class="hljs-type">byte</span>[] data = event.getData().getData();<br>                System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(data));<br>            &#125;<br>        &#125;<br>    &#125;);<br>    <span class="hljs-comment">//3. 开启</span><br>    pathChildrenCache.start();<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-10-Zookeeper-JavaAPI操作-Watch监听-TreeCache"><a href="#4-10-Zookeeper-JavaAPI操作-Watch监听-TreeCache" class="headerlink" title="4.10)Zookeeper JavaAPI操作-Watch监听-TreeCache"></a><strong>4.10)Zookeeper</strong> JavaAPI操作-Watch监听-TreeCache</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 演示 TreeCache：监听某个节点自己和所有子节点们</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTreeCache</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//1. 创建监听器</span><br>    <span class="hljs-type">TreeCache</span> <span class="hljs-variable">treeCache</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeCache</span>(client,<span class="hljs-string">&quot;/app2&quot;</span>);<br>    <span class="hljs-comment">//2. 注册监听</span><br>    treeCache.getListenable().addListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeCacheListener</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">childEvent</span><span class="hljs-params">(CuratorFramework client, TreeCacheEvent event)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            System.out.println(<span class="hljs-string">&quot;节点变化了&quot;</span>);<br>            System.out.println(event);<br>        &#125;<br>    &#125;);<br>    <span class="hljs-comment">//3. 开启</span><br>    treeCache.start();<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-11-Zookeeper分布式锁-概念"><a href="#4-11-Zookeeper分布式锁-概念" class="headerlink" title="4.11)Zookeeper分布式锁-概念"></a>4.11)Zookeeper分布式锁-概念</h3><p>•在我们进行单机应用开发，涉及并发同步的时候，我们往往采用synchronized或者Lock的方式来解决多线程间的代码同步问题，这时多线程的运行都是在同一个JVM之下，没有任何问题。</p>
<p>•但当我们的应用是分布式集群工作的情况下，属于多JVM下的工作环境，跨JVM之间已经无法通过多线程的锁解决同步问题。</p>
<p>•那么就需要一种更加高级的锁机制，来处理种跨机器的进程之间的数据同步问题——这就是分布式锁。</p>
<p>![1592057871141](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1592057871141.png)</p>
<h3 id="4-12-Zookeeper-分布式锁-zookeeper分布式锁原理"><a href="#4-12-Zookeeper-分布式锁-zookeeper分布式锁原理" class="headerlink" title="4.12)Zookeeper 分布式锁-zookeeper分布式锁原理"></a><strong>4.12)Zookeeper</strong> 分布式锁-zookeeper分布式锁原理</h3><p>•核心思想：当客户端要获取锁，则创建节点，使用完锁，则删除该节点。</p>
<p>1.客户端获取锁时，在lock节点下创建临时顺序节点。</p>
<p>2.然后获取lock下面的所有子节点，客户端获取到所有的子节点之后，如果发现自己创建的子节点序号最小，那么就认为该客户端获取到了锁。使用完锁后，将该节点删除。</p>
<p>3.如果发现自己创建的节点并非lock所有子节点中最小的，说明自己还没有获取到锁，此时客户端需要找到比自己小的那个节点，同时对其注册事件监听器，监听删除事件。</p>
<p>4.如果发现比自己小的那个节点被删除，则客户端的</p>
<p>​    Watcher会收到相应通知，此时再次判断自己创建的节点</p>
<p>​    是否是lock子节点中序号最小的，如果是则获取到了锁，</p>
<p>​    如果不是则重复以上步骤继续获取到比自己小的一个节点</p>
<p>​    并注册监听。</p>
<p>![1592057925831](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1592057925831.png)</p>
<h3 id="4-13-Zookeeper-分布式锁-模拟12306售票案例"><a href="#4-13-Zookeeper-分布式锁-模拟12306售票案例" class="headerlink" title="4.13)Zookeeper 分布式锁-模拟12306售票案例"></a><strong>4.13)Zookeeper</strong> 分布式锁-模拟12306售票案例</h3><p><strong>Curator实现分布式锁API</strong></p>
<ul>
<li><p>在Curator中有五种锁方案：</p>
<ul>
<li><p>InterProcessSemaphoreMutex：分布式排它锁（非可重入锁）</p>
</li>
<li><p>InterProcessMutex：分布式可重入排它锁</p>
</li>
<li><p>InterProcessReadWriteLock：分布式读写锁</p>
</li>
<li><p>InterProcessMultiLock：将多个锁作为单个实体管理的容器</p>
</li>
<li><p>InterProcessSemaphoreV2：共享信号量</p>
</li>
</ul>
</li>
</ul>
<p>![1592058017457](D:&#x2F;BaiduNetdiskDownload&#x2F;黑马微服务&#x2F;5.Zookeeper【海量资源尽在 】&#x2F;21-Zookeeper&#x2F;讲义&#x2F;assets&#x2F;1592058017457.png)</p>
<p>1,创建线程进行加锁设置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Ticket12306</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">tickets</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<span class="hljs-comment">//数据库的票数</span><br>    <span class="hljs-keyword">private</span> InterProcessMutex lock ;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>            <span class="hljs-comment">//获取锁</span><br>            <span class="hljs-keyword">try</span> &#123;<br>            lock.acquire(<span class="hljs-number">3</span>, TimeUnit.SECONDS);<br>                <span class="hljs-keyword">if</span>(tickets &gt; <span class="hljs-number">0</span>)&#123;<br>                    System.out.println(Thread.currentThread()+<span class="hljs-string">&quot;:&quot;</span>+tickets);<br>                    Thread.sleep(<span class="hljs-number">100</span>);<br>                    tickets--;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-comment">//释放锁</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    lock.release();<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2,创建连接，并且初始化锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Ticket12306</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">//重试策略</span><br>    <span class="hljs-type">RetryPolicy</span> <span class="hljs-variable">retryPolicy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExponentialBackoffRetry</span>(<span class="hljs-number">3000</span>, <span class="hljs-number">10</span>);<br>    <span class="hljs-comment">//2.第二种方式</span><br>    <span class="hljs-comment">//CuratorFrameworkFactory.builder();</span><br>    <span class="hljs-type">CuratorFramework</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> CuratorFrameworkFactory.builder()<br>        .connectString(<span class="hljs-string">&quot;192.168.149.135:2181&quot;</span>)<br>        .sessionTimeoutMs(<span class="hljs-number">60</span> * <span class="hljs-number">1000</span>)<br>        .connectionTimeoutMs(<span class="hljs-number">15</span> * <span class="hljs-number">1000</span>)<br>        .retryPolicy(retryPolicy)<br>        .build();<br>    <span class="hljs-comment">//开启连接</span><br>    client.start();<br>    lock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterProcessMutex</span>(client,<span class="hljs-string">&quot;/lock&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>3,运行多个线程进行测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Ticket12306</span> <span class="hljs-variable">ticket12306</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Ticket12306</span>();<br>        <span class="hljs-comment">//创建客户端</span><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(ticket12306,<span class="hljs-string">&quot;携程&quot;</span>);<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(ticket12306,<span class="hljs-string">&quot;飞猪&quot;</span>);<br>        t1.start();<br>        t2.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="5-ZooKeeper-集群搭建"><a href="#5-ZooKeeper-集群搭建" class="headerlink" title="5)ZooKeeper 集群搭建"></a>5)ZooKeeper 集群搭建</h2><h3 id="5-1-Zookeeper集群介绍"><a href="#5-1-Zookeeper集群介绍" class="headerlink" title="5.1)Zookeeper集群介绍"></a><strong>5.1)Zookeeper</strong>集群介绍</h3><p>Leader选举：</p>
<p>•Serverid：服务器ID</p>
<p>  比如有三台服务器，编号分别是1,2,3。</p>
<p>  编号越大在选择算法中的权重越大。</p>
<p>•Zxid：数据ID</p>
<p>  服务器中存放的最大数据ID.值越大说明数据  越新，在选举算法中数据越新权重越大。</p>
<p>•在Leader选举的过程中，如果某台ZooKeeper</p>
<p>​    获得了超过半数的选票，</p>
<p>​    则此ZooKeeper就可以成为Leader了。</p>
<h3 id="5-2-搭建要求"><a href="#5-2-搭建要求" class="headerlink" title="5.2)搭建要求"></a>5.2)搭建要求</h3><p>真实的集群是需要部署在不同的服务器上的，但是在我们测试时同时启动很多个虚拟机内存会吃不消，所以我们通常会搭建<strong>伪集群</strong>，也就是把所有的服务都搭建在一台虚拟机上，用端口进行区分。</p>
<p>我们这里要求搭建一个三个节点的Zookeeper集群（伪集群）。</p>
<h3 id="5-3-准备工作"><a href="#5-3-准备工作" class="headerlink" title="5.3)准备工作"></a><strong>5.3)准备工作</strong></h3><p>重新部署一台虚拟机作为我们搭建集群的测试服务器。</p>
<p>（1）安装JDK  【此步骤省略】。</p>
<p>（2）Zookeeper压缩包上传到服务器<br>（3）将Zookeeper解压 ，建立&#x2F;usr&#x2F;local&#x2F;zookeeper-cluster目录，将解压后的Zookeeper复制到以下三个目录</p>
<p>&#x2F;usr&#x2F;local&#x2F;zookeeper-cluster&#x2F;zookeeper-1</p>
<p>&#x2F;usr&#x2F;local&#x2F;zookeeper-cluster&#x2F;zookeeper-2</p>
<p>&#x2F;usr&#x2F;local&#x2F;zookeeper-cluster&#x2F;zookeeper-3</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost ~]# mkdir /usr/local/zookeeper-cluster<br>[root@localhost ~]# cp -r  apache-zookeeper-3.5.6-bin /usr/local/zookeeper-cluster/zookeeper-1<br>[root@localhost ~]# cp -r  apache-zookeeper-3.5.6-bin /usr/local/zookeeper-cluster/zookeeper-2<br>[root@localhost ~]# cp -r  apache-zookeeper-3.5.6-bin /usr/local/zookeeper-cluster/zookeeper-3<br></code></pre></td></tr></table></figure>

<p>（4）创建data目录 ，并且将 conf下zoo_sample.cfg 文件改名为 zoo.cfg</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir /usr/local/zookeeper-cluster/zookeeper-1/data<br>mkdir /usr/local/zookeeper-cluster/zookeeper-2/data<br>mkdir /usr/local/zookeeper-cluster/zookeeper-3/data<br><br>mv  /usr/local/zookeeper-cluster/zookeeper-1/conf/zoo_sample.cfg  /usr/local/zookeeper-cluster/zookeeper-1/conf/zoo.cfg<br>mv  /usr/local/zookeeper-cluster/zookeeper-2/conf/zoo_sample.cfg  /usr/local/zookeeper-cluster/zookeeper-2/conf/zoo.cfg<br>mv  /usr/local/zookeeper-cluster/zookeeper-3/conf/zoo_sample.cfg  /usr/local/zookeeper-cluster/zookeeper-3/conf/zoo.cfg<br></code></pre></td></tr></table></figure>





<p>（5） 配置每一个Zookeeper 的dataDir 和 clientPort 分别为2181  2182  2183</p>
<p>修改&#x2F;usr&#x2F;local&#x2F;zookeeper-cluster&#x2F;zookeeper-1&#x2F;conf&#x2F;zoo.cfg</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /usr/local/zookeeper-cluster/zookeeper-1/conf/zoo.cfg<br><br>clientPort=2181<br>dataDir=/usr/local/zookeeper-cluster/zookeeper-1/data<br></code></pre></td></tr></table></figure>

<p>修改&#x2F;usr&#x2F;local&#x2F;zookeeper-cluster&#x2F;zookeeper-2&#x2F;conf&#x2F;zoo.cfg</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /usr/local/zookeeper-cluster/zookeeper-2/conf/zoo.cfg<br><br>clientPort=2182<br>dataDir=/usr/local/zookeeper-cluster/zookeeper-2/data<br></code></pre></td></tr></table></figure>

<p>修改&#x2F;usr&#x2F;local&#x2F;zookeeper-cluster&#x2F;zookeeper-3&#x2F;conf&#x2F;zoo.cfg</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /usr/local/zookeeper-cluster/zookeeper-3/conf/zoo.cfg<br><br>clientPort=2183<br>dataDir=/usr/local/zookeeper-cluster/zookeeper-3/data<br></code></pre></td></tr></table></figure>



<h3 id="5-4-配置集群"><a href="#5-4-配置集群" class="headerlink" title="5.4)配置集群"></a><strong>5.4)配置集群</strong></h3><p>（1）在每个zookeeper的 data 目录下创建一个 myid 文件，内容分别是1、2、3 。这个文件就是记录每个服务器的ID</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">echo 1 &gt;/usr/local/zookeeper-cluster/zookeeper-1/data/myid<br>echo 2 &gt;/usr/local/zookeeper-cluster/zookeeper-2/data/myid<br>echo 3 &gt;/usr/local/zookeeper-cluster/zookeeper-3/data/myid<br></code></pre></td></tr></table></figure>





<p>（2）在每一个zookeeper 的 zoo.cfg配置客户端访问端口（clientPort）和集群服务器IP列表。</p>
<p>集群服务器IP列表如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /usr/local/zookeeper-cluster/zookeeper-1/conf/zoo.cfg<br>vim /usr/local/zookeeper-cluster/zookeeper-2/conf/zoo.cfg<br>vim /usr/local/zookeeper-cluster/zookeeper-3/conf/zoo.cfg<br><br>server.1=192.168.149.135:2881:3881<br>server.2=192.168.149.135:2882:3882<br>server.3=192.168.149.135:2883:3883<br></code></pre></td></tr></table></figure>

<p>解释：server.服务器ID&#x3D;服务器IP地址：服务器之间通信端口：服务器之间投票选举端口</p>
<h3 id="5-5-启动集群"><a href="#5-5-启动集群" class="headerlink" title="5.5)启动集群"></a><strong>5.5)启动集群</strong></h3><p>启动集群就是分别启动每个实例。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh start<br>/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh start<br>/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh start<br></code></pre></td></tr></table></figure>



<p><img src="G:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps11.jpg" srcset="/img/loading.gif" lazyload alt="img"> </p>
<p>启动后我们查询一下每个实例的运行状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh status<br>/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status<br>/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh status<br></code></pre></td></tr></table></figure>



<p>先查询第一个服务</p>
<p><img src="G:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps12.jpg" srcset="/img/loading.gif" lazyload alt="img"> </p>
<p>Mode为follower表示是<strong>跟随者</strong>（从）</p>
<p>再查询第二个服务Mod 为leader表示是<strong>领导者</strong>（主）</p>
<p><img src="G:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps13.jpg" srcset="/img/loading.gif" lazyload alt="img"> </p>
<p>查询第三个为跟随者（从）</p>
<p><img src="G:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps14.jpg" srcset="/img/loading.gif" lazyload alt="img"> </p>
<h3 id="5-6-模拟集群异常"><a href="#5-6-模拟集群异常" class="headerlink" title="5.6)模拟集群异常"></a><strong>5.6)模拟集群异常</strong></h3><p>（1）首先我们先测试如果是从服务器挂掉，会怎么样</p>
<p>把3号服务器停掉，观察1号和2号，发现状态并没有变化</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh stop<br><br>/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh status<br>/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status<br></code></pre></td></tr></table></figure>

<p><img src="G:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps15.jpg" srcset="/img/loading.gif" lazyload alt="img"> </p>
<p>由此得出结论，3个节点的集群，从服务器挂掉，集群正常</p>
<p>（2）我们再把1号服务器（从服务器）也停掉，查看2号（主服务器）的状态，发现已经停止运行了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh stop<br><br>/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status<br></code></pre></td></tr></table></figure>



<p><img src="G:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps16.jpg" srcset="/img/loading.gif" lazyload alt="img"> </p>
<p>由此得出结论，3个节点的集群，2个从服务器都挂掉，主服务器也无法运行。因为可运行的机器没有超过集群总数量的半数。</p>
<p>（3）我们再次把1号服务器启动起来，发现2号服务器又开始正常工作了。而且依然是领导者。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh start<br><br>/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status<br></code></pre></td></tr></table></figure>



<p><img src="G:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps17.jpg" srcset="/img/loading.gif" lazyload alt="img"> </p>
<p>（4）我们把3号服务器也启动起来，把2号服务器停掉,停掉后观察1号和3号的状态。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh start<br>/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh stop<br><br>/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh status<br>/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh status<br></code></pre></td></tr></table></figure>



<p><img src="G:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps18.jpg" srcset="/img/loading.gif" lazyload alt="img"> </p>
<p>发现新的leader产生了~  </p>
<p>由此我们得出结论，当集群中的主服务器挂了，集群中的其他服务器会自动进行选举状态，然后产生新得leader </p>
<p>（5）我们再次测试，当我们把2号服务器重新启动起来启动后，会发生什么？2号服务器会再次成为新的领导吗？我们看结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh start<br><br>/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status<br>/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh status<br></code></pre></td></tr></table></figure>



<p><img src="G:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps19.jpg" srcset="/img/loading.gif" lazyload alt="img"><img src="G:/2020%E6%96%B0%E8%AF%BE%E7%A8%8B/zookeeper-2020-%E8%AF%BE%E4%BB%B6/%E8%B5%84%E6%96%99/images/wps20.jpg" srcset="/img/loading.gif" lazyload alt="img"> </p>
<p>我们会发现，2号服务器启动后依然是跟随者（从服务器），3号服务器依然是领导者（主服务器），没有撼动3号服务器的领导地位。</p>
<p>由此我们得出结论，当领导者产生后，再次有新服务器加入集群，不会影响到现任领导者。</p>
<h2 id="6-Zookeeper-核心理论"><a href="#6-Zookeeper-核心理论" class="headerlink" title="6)Zookeeper 核心理论"></a>6)Zookeeper 核心理论</h2><p><strong>Zookeepe集群角色</strong></p>
<p>在ZooKeeper集群服中务中有三个角色：</p>
<p>•Leader 领导者 ：          </p>
<p>​	1. 处理事务请求</p>
<p>​	2. 集群内部各服务器的调度者</p>
<p>•Follower 跟随者 ：</p>
<p>​	1. 处理客户端非事务请求，转发事务请求给Leader服务器</p>
<p>​	2. 参与Leader选举投票</p>
<p>•Observer 观察者：</p>
<pre><code class="hljs">1. 处理客户端非事务请求，转发事务请求给Leader服务器
</code></pre>
<p><img src="/assets%5C1592058451822.png" srcset="/img/loading.gif" lazyload alt="1592058451822"></p>
<h1 id="Spring-Cloud"><a href="#Spring-Cloud" class="headerlink" title="Spring Cloud"></a>Spring Cloud</h1><h2 id="高级特性"><a href="#高级特性" class="headerlink" title="高级特性"></a>高级特性</h2><blockquote>
</blockquote>
<p>Spring提供了一个RestTemplate模板工具类，对基于Http的客户端进行了封装，并且实现了对象与json的序列化和 反序列化，非常方便。RestTemplate并没有限定Http的客户端类型，而是进行了抽象，目前常用的3种都有支持： HttpClient OkHttp JDK原生的URLConnection（默认的）</p>
<h2 id="RestTemplate的使用"><a href="#RestTemplate的使用" class="headerlink" title="RestTemplate的使用"></a>RestTemplate的使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;<br><span class="hljs-comment">//注册bean</span><br><span class="hljs-comment">//使用方法 发动请求,接收响应,并且帮我们对响应结果进行反序列化</span><br><span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://localhost/user/8&quot;</span>;<br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> restTemplate.getForObject(url, User.class);<br>System.out.println(user);<br><br></code></pre></td></tr></table></figure>

<p>Spring Cloud</p>
<h2 id="实践1-编写消费者和生产者-无注册中心"><a href="#实践1-编写消费者和生产者-无注册中心" class="headerlink" title="实践1 编写消费者和生产者(无注册中心)"></a>实践1 编写消费者和生产者(无注册中心)</h2><p>生产者:常规后端</p>
<p>​	spring boot应用, entity,service实现增删改查业务,controller接收请求调用业务进行处理,返回给请求者</p>
<p>消费者:简单controller使用restT请求生产者</p>
<p>网页访问消费者,消费者通过resttemplate(硬编码)请求生产者</p>
<p>存在的问题</p>
<ul>
<li><p>url硬编码</p>
<p>如果变更,得不到通知地址将失效,不清楚服务状态,服务宕机也不知道</p>
<p>(采用注册中心对服务进行治理</p>
<p>​	自动注册和发现</p>
<p>​		服务注册到注册中心(服务类型,联系方式)</p>
<p>​		消费者向服务中心订阅服务,选择服务类型,注册中心自动安排一个符合需求的服务</p>
<p>​	状态监管  “心跳(续约)机制” 定期通过http向Eureka刷新自己的状态</p>
<p>​	动态路由</p>
</li>
<li><p>一台生产者不具备高可用(集群解决,如何实现负载均衡)</p>
</li>
<li><p>容灾问题 </p>
</li>
<li><p>服务如何实现统一配置</p>
</li>
</ul>
<h2 id="实践2-搭建Eureka-server工程"><a href="#实践2-搭建Eureka-server工程" class="headerlink" title="实践2 搭建Eureka-server工程"></a>实践2 搭建Eureka-server工程</h2><h3 id="Eureka注册中心"><a href="#Eureka注册中心" class="headerlink" title="Eureka注册中心"></a>Eureka注册中心</h3><p>EurekaServer主要功能:检查那些没有定期发送心跳的,记录服务,	自我保护机制(todo)</p>
<p>EurekaClient主要功能: 从Server拉取服务列表,基于负载均衡算法对远程服务进行调用,定时续约,	设置剔除时间(?)</p>
<p>搭建</p>
<ul>
<li>添加依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<ul>
<li><p>添加Eureka的服务注解</p>
<p>@EnableEurekaServer 开启服务发现功能</p>
</li>
<li><p>编写配置</p>
<ul>
<li>服务名,服务端口号</li>
<li>eureka客户端配置<ul>
<li>service-url: defaultZone</li>
<li>register-with-eureka: 是否注册 默认true</li>
<li>fetch-registry: 是否拉取服务 默认true</li>
<li></li>
</ul>
</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">10086</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eureka-server</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-comment"># eureka 服务地址，如果是集群的话；需要指定其它集群eureka地址</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br>    <span class="hljs-comment"># 不注册自己</span><br>    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-comment"># 不拉取服务</span><br>    <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">false</span><br>    <br></code></pre></td></tr></table></figure>


</li>
<li><p>启动测试</p>
</li>
</ul>
<p>	</p>
<p>依赖是~client</p>
<p>客户端的注解是@EnableDiscoveryClient </p>
<p>客户端常用配置:</p>
<ul>
<li>续约间隔</li>
<li>服务失效时间</li>
<li>获取服务地址列表间隔时间</li>
</ul>
<h3 id="Eureka配置"><a href="#Eureka配置" class="headerlink" title="Eureka配置"></a>Eureka配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;<br><span class="hljs-comment">//在启动类添加 @EnableEurekaServer</span><br>***<br> <span class="hljs-comment">//编写配置文件</span><br>    <span class="hljs-comment">//网页端口</span><br>    <span class="hljs-comment">//应用名称 eureka-server(作为服务的id表示 serviceID)</span><br>    <br>eureka:<br>client:<br>service-url: # EurekaServer的地址，现在是自己的地址，如果是集群，需要写其它Server的地址。<br>defaultZone: http:<span class="hljs-comment">//127.0.0.1:10086/eureka</span><br>register-with-eureka: <span class="hljs-literal">false</span> # 不注册自己<br>fetch-registry: <span class="hljs-literal">false</span> #不拉取<br>启动服务<br>    <br></code></pre></td></tr></table></figure>

<h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><p>生产者添加eureka依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">启动类添加<span class="hljs-meta">@EnabeDiscoveryClient</span>开启Eureka客户端功能<br>    <span class="hljs-comment">//修改配置</span><br>    eureka:<br>client:<br>service-url:<br>defaultZone: http:<span class="hljs-comment">//localhost:10086/eureka</span><br></code></pre></td></tr></table></figure>

<h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><p>消费者</p>
<p>添加依赖</p>
<p>修改启动类和配置(同生产者)</p>
<p>修改处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://localhost:9091/user/&quot;</span> + id;<br><span class="hljs-comment">//获取eureka中注册的user-service实例列表</span><br>List&lt;ServiceInstance&gt; serviceInstanceList =<br>discoveryClient.getInstances(<span class="hljs-string">&quot;user-service&quot;</span>);<br><span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">serviceInstance</span> <span class="hljs-operator">=</span> serviceInstanceList.get(<span class="hljs-number">0</span>);<br>url = <span class="hljs-string">&quot;http://&quot;</span> + serviceInstance.getHost() + <span class="hljs-string">&quot;:&quot;</span> + serviceInstance.getPort()<br>+ <span class="hljs-string">&quot;/user/&quot;</span> + id;<br><span class="hljs-keyword">return</span> restTemplate.getForObject(url, User.class);<br><br></code></pre></td></tr></table></figure>

<p>服务者从注册中心获取服务列表,从而得知每个服务方的信息,</p>
<p>Eureka可以是集群,形成高可用</p>
<p>多个之间互相注册服务,有注册时,会同步到每个节点    </p>
<p>三个的集群注册规则        </p>
<p>​	10086要注册到10087和10088上 </p>
<p>​	10087要注册到10086和10088上 </p>
<p>​	10088要注册到10086和10087上</p>
<h2 id="实践3-搭建Eureka集群"><a href="#实践3-搭建Eureka集群" class="headerlink" title="实践3 搭建Eureka集群"></a>实践3 搭建Eureka集群</h2><p>多机集群 只需要区分IP 端口号可相同</p>
<p>在本机模拟 在启动时修改VM options defaultzone复制个项目 修改端口号启动多个服务</p>
<p><img src="C:\Users\再难也会过\AppData\Roaming\Typora\typora-user-images\image-20220627103529460.png" srcset="/img/loading.gif" lazyload alt="image-20220627103529460"></p>
<p>客户端注册</p>
<p>添加注册(???不应该还是注册到一个中心,中心间相互数据同步吗)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">eureka:<br>client:<br>service-url: # EurekaServer地址,多个地址以<span class="hljs-string">&#x27;,&#x27;</span>隔开<br>defaultZone: http:<span class="hljs-comment">//127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka</span><br></code></pre></td></tr></table></figure>

<p>生产者会向Eureka服务发起一个Rest请求,并携带自己的元数据信息,Eureka</p>
<p>将信息保存到双层map</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;name(服务ID),Map&lt;localhost:user-service:<span class="hljs-number">8081</span>(实例ID), &gt; &gt;<br></code></pre></td></tr></table></figure>

<p>默认注册使用主机名或localHost 如果想用ip注册</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-string">//生产者中</span><br><span class="hljs-attr">eureka:</span><br><span class="hljs-attr">instance:</span><br><span class="hljs-attr">ip-address:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-comment"># ip地址</span><br><span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 更倾向于使用ip，而不是host名</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>服务续约</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">eureka:</span><br><span class="hljs-attr">instance:</span><br><span class="hljs-attr">lease-expiration-duration-in-seconds:</span> <span class="hljs-number">90</span> <br><span class="hljs-attr">lease-renewal-interval-in-seconds:</span> <span class="hljs-number">30</span> <br></code></pre></td></tr></table></figure>

<p>服务失效 默认 90s 认为服务宕机 从服务列表中移除</p>
<p>心跳 30s一次</p>
<blockquote>
<p>获取服务列表</p>
</blockquote>
<p>当服务消费者启动时，会检测 eureka.client.fetch-registry&#x3D;true 参数的值，如果为true，则会从Eureka Server服务的列表拉取只读备份，然后缓存在本地。并且 每隔30秒 会重新拉取并更新数据。可以在 consumer-demo 项目中通过下面的参数来修改：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">eureka:</span><br><span class="hljs-attr">client:</span><br><span class="hljs-attr">registry-fetch-interval-seconds:</span> <span class="hljs-number">30</span><br></code></pre></td></tr></table></figure>



<p>失效剔除和自我保护</p>
<blockquote>
<p>服务下线</p>
</blockquote>
<p>当服务进行正常关闭操作时，它会触发一个服务下线的REST请求给Eureka Server，告诉服务注册中心：“我要下线 了”。服务中心接受到请求之后，将该服务置为下线状态</p>
<blockquote>
<p>失效剔除</p>
</blockquote>
<p>有时我们的服务可能由于内存溢出或网络故障等原因使得服务不能正常的工作，而服务注册中心并未收到“服务下 线”的请求。相对于服务提供者的“服务续约”操作，服务注册中心在启动时会创建一个定时任务，默认每隔一段时间 （默认为60秒）将当前清单中超时（默认为90秒）没有续约的服务剔除，这个操作被称为失效剔除。 可以通过 eureka.server.eviction-interval-timer-in-ms 参数对其进行修改，单位是毫秒。</p>
<blockquote>
<p>自我保护</p>
</blockquote>
<p>当服务未按时进行心跳续约时，Eureka会统计服务实例最近15分钟心跳续约的 比例是否低于了85%。在生产环境下，因为网络延迟等原因，心跳失败实例的比例很有可能超标，但是此时就把服务 剔除列表并不妥当，因为服务可能没有宕机。Eureka在这段时间内不会剔除任何服务实例，直到网络恢复正常。生 产环境下这很有效，保证了大多数服务依然可用，不过也有可能获取到失败的服务实例，因此服务调用者必须做好服 务的失败容错。 可以通过下面的配置来关停自我保护：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">eureka:</span><br><span class="hljs-attr">server:</span><br><span class="hljs-attr">enable-self-preservation:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 关闭自我保护模式（缺省为打开）</span><br></code></pre></td></tr></table></figure>



<h2 id="实践4-负载均衡Ribbon"><a href="#实践4-负载均衡Ribbon" class="headerlink" title="实践4 负载均衡Ribbon"></a>实践4 负载均衡Ribbon</h2><p>在实际环境中往往会开启很多个 user-service的集群,此时discoveryClient 获取的服务列表有多个,到底该访问哪一个呢</p>
<p>​	负载均衡算法就是在多个实例列表中进行选择</p>
<p>Eureka中集成了 ribbon 简单修改代码即可(提供例如轮询(默认),随机等)</p>
<p>1.首先 配置两个 user-service实例 启动两个,动态设置启动端口号</p>
<p>2.在RestTemplate的bean方法上添加 @LoadBalanced注解</p>
<p>3.不再手动获取IP和端口 而是直接通过服务名称调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> User <span class="hljs-title function_">queryById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://user-service/user/&quot;</span> + id;<br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> restTemplate.getForObject(url, User.class);<br><span class="hljs-keyword">return</span> user;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>默认轮询,boot提供修改负载均衡配置入口</p>
<p>在消费者中加</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">user-service:</span><br><span class="hljs-attr">ribbon:</span><br><span class="hljs-attr">NFLoadBalancerRuleClassName:</span> <span class="hljs-string">com.netflix.loadbalancer.RandomRule</span><br><br></code></pre></td></tr></table></figure>



<h2 id="实验5-熔断器Hystrix-服务降级"><a href="#实验5-熔断器Hystrix-服务降级" class="headerlink" title="实验5 熔断器Hystrix 服务降级"></a>实验5 熔断器Hystrix 服务降级</h2><p>延迟和容错库,用于隔离访问远程访问,第三方库,防止出现级联失败</p>
<p>雪崩问题:微服务间一个请求可能需要调用多个微服务接口才能实现</p>
<p>如果某个服务异常,请求不会得到响应,则tomcat的这个线程不会释放,于是越来越多的用户到来,越来越多的线程阻塞,导致服务器资源耗尽,其他所有服务都不可用,形成雪崩效应,一个微服务的阻塞导致整个服务的瘫痪</p>
<p>熔断器Hystrix的解决手段:</p>
<ul>
<li><p>线程隔离</p>
<ul>
<li><p>为每个依赖服务调用分配一个小的线程池</p>
</li>
<li><p>如果线程池已满调用将被立即拒绝,默认不采用排队,加速失败判定时间</p>
</li>
<li><blockquote>
<p>服务降级</p>
<p>如果线程池满,或请求超时会进行服务降级:优先保证核心服务,非核心不可用或弱可用</p>
</blockquote>
</li>
</ul>
</li>
<li><p>服务熔断</p>
<ul>
<li>断开服务,防止整个系统被拖垮</li>
</ul>
</li>
</ul>
<p>1.添加依赖</p>
<p>2.启动类开启熔断</p>
<p>@EnableCircuitBreaker</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs YML"><span class="hljs-string">组合注解</span><br><span class="hljs-string">@SpringCloudApplication</span><br>	<span class="hljs-string">@SpringBootApplication</span><br>	<span class="hljs-string">@EnableDiscoveryClient</span><br>	<span class="hljs-string">@EnableCircuitBreaker</span><br>	<br></code></pre></td></tr></table></figure>

<p>3.编写降级逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.consumer.controller;<br><span class="hljs-keyword">import</span> com.itheima.consumer.pojo.User;<br><span class="hljs-keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.cloud.client.ServiceInstance;<br><span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.DiscoveryClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/consumer&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumerController</span> &#123;<br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> DiscoveryClient discoveryClient;<br><span class="hljs-meta">@GetMapping(&quot;&#123;id&#125;&quot;)</span><br><span class="hljs-meta">@HystrixCommand(fallbackMethod = &quot;queryByIdFallback&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">queryById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>&#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://localhost:9091/user/&quot;</span> + id;<br><span class="hljs-comment">//获取eureka中注册的user-service实例列表</span><br><span class="hljs-comment">/*List&lt;ServiceInstance&gt; serviceInstanceList =</span><br><span class="hljs-comment">discoveryClient.getInstances(&quot;user-service&quot;);</span><br><span class="hljs-comment">ServiceInstance serviceInstance = serviceInstanceList.get(0);</span><br><span class="hljs-comment">url = &quot;http://&quot; + serviceInstance.getHost() + &quot;:&quot; + serviceInstance.getPort()</span><br><span class="hljs-comment">+ &quot;/user/&quot; + id;*/</span><br>url = <span class="hljs-string">&quot;http://user-service/user/&quot;</span> + id;<br><span class="hljs-keyword">return</span> restTemplate.getForObject(url, String.class);<br>&#125;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">queryByIdFallback</span><span class="hljs-params">(Long id)</span>&#123;<br>log.error(<span class="hljs-string">&quot;查询用户信息失败。id：&#123;&#125;&quot;</span>, id);<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;对不起，网络太拥挤了！&quot;</span>;<br>    <span class="hljs-comment">//相同的参数列表和返回值声明</span><br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>不写方法 默认fallbcak</p>
<h2 id="实践6-服务熔断"><a href="#实践6-服务熔断" class="headerlink" title="实践6 服务熔断"></a>实践6 服务熔断</h2><p>熔断器三个状态</p>
<p>关闭 所有请求正常访问</p>
<p>打开 所有请求都会被降级 ,请求次数不低于20次 失败比例 到达一半 触发熔断</p>
<p>半开 熔断器打开后会计时5s转为此状态(半开),释放部分请求,若都是健康的则关闭,否则保持打开,再次进行5s计时</p>
<p>源码阅读 配置 todo</p>
<h2 id="实践7-Feigh-伪装"><a href="#实践7-Feigh-伪装" class="headerlink" title="实践7 Feigh(伪装)"></a>实践7 Feigh(伪装)</h2><p>把rest的请求进行隐藏,伪装成类似springMVC的controller一样 不用自己拼接url参数等等,一切交给Feign</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.consumer.client;<br><span class="hljs-keyword">import</span> com.itheima.consumer.pojo.User;<br><span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-meta">@FeignClient(&quot;user-service&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserClient</span> &#123;<br><span class="hljs-meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span><br>User <span class="hljs-title function_">queryById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>首先这是一个接口 feign会通过动态代理,帮我们生成实现类,跟mybatis的mapper很像</p>
<p>编写新的控制器类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.consumer.controller;<br><span class="hljs-keyword">import</span> com.itheima.consumer.client.UserClient;<br><span class="hljs-keyword">import</span> com.itheima.consumer.pojo.User;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/cf&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumerFeignController</span> &#123;<br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> UserClient userClient;<br><span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> User <span class="hljs-title function_">queryById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>&#123;<br><span class="hljs-keyword">return</span> userClient.queryById(id);<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>在启动类开启feign功能</p>
<p>@EnableFeignClients</p>
<p>可以开启请求压缩 gzip减少通信过程中的性能损耗</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">feign:</span><br><span class="hljs-attr">compression:</span><br><span class="hljs-attr">request:</span><br><span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启请求压缩</span><br><span class="hljs-attr">response:</span><br><span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启响应压缩</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">feign:<br>compression:<br>request:<br>enabled: <span class="hljs-literal">true</span> # 开启请求压缩<br>mime-types: text/html,application/xml,application/json # 设置压缩的数据类型<br>min-request-size: <span class="hljs-number">2048</span> # 设置触发压缩的大小下限<br><span class="hljs-comment">//默认</span><br></code></pre></td></tr></table></figure>



<h3 id="日志级别-了解"><a href="#日志级别-了解" class="headerlink" title="日志级别(了解)"></a>日志级别(了解)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">logging:<br>level:<br>com.itheima: debug<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.consumer.config;<br><span class="hljs-keyword">import</span> feign.Logger;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignConfig</span> &#123;<br><span class="hljs-meta">@Bean</span><br>Logger.Level <span class="hljs-title function_">feignLoggerLevel</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-comment">//记录所有请求和响应的明细，包括头信息、请求体、元数据</span><br><span class="hljs-keyword">return</span> Logger.Level.FULL;<br>    <span class="hljs-comment">/*NONE：不记录任何日志信息，这是默认值。</span><br><span class="hljs-comment">BASIC：仅记录请求的方法，URL以及响应状态码和执行时间</span><br><span class="hljs-comment">HEADERS：在BASIC的基础上，额外记录了请求和响应的头信息</span><br><span class="hljs-comment">FULL：记录所有请求和响应的明细，包括头信息、请求体、元数据。*/</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>观察日志</p>
<h2 id="实践8-Gateway替代-netflix-zuul"><a href="#实践8-Gateway替代-netflix-zuul" class="headerlink" title="实践8 Gateway替代 netflix zuul"></a>实践8 Gateway替代 netflix zuul</h2><p>核心是一系列的过滤器,通过这些过滤器可以将客户端发送的请求转发(路由)到对应微服务,是加在整个微服务最前沿的防火墙和代理器,隐藏微服务结点IP端口信息,从而加强安全保护,本身也是一个微服务,需要注册到中心</p>
<p>核心功能:</p>
<p>​	路由:路由信息的组成:由一个ID,一个目的URL,一组断言工厂,一组Filter组成 如果路由断言为真,说明请求URL和配置路由匹配</p>
<p>​	断言: 网关中的断言函数输入类型是Spring5.0中的 ServerWebExchange,断言函数允许开发者去定义匹配来自于Http request中的任何信息比如请求头和参数</p>
<p>​	过滤器: 标准 spring WebFilter 网关中有两种filter  分别是 网关过滤器和 全局过滤器,过滤器将会对请求和响应进行修改处理</p>
<p><img src="C:\Users\再难也会过\AppData\Roaming\Typora\typora-user-images\image-20220628105208537.png" srcset="/img/loading.gif" lazyload alt="image-20220628105208537"></p>
<p>快速入门</p>
<p>创建项目(模块Maven)</p>
<h3 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1.引入依赖"></a>1.引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0</span></span><br><span class="hljs-string"><span class="hljs-tag">http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>heima-springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itheima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itheima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>heima-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h3 id="2-编写启动类"><a href="#2-编写启动类" class="headerlink" title="2.编写启动类"></a>2.编写启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.gateway;<br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayApplication</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>SpringApplication.run(GatewayApplication.class, args);<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="3-编写配置"><a href="#3-编写配置" class="headerlink" title="3.编写配置"></a>3.编写配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br><span class="hljs-attr">port:</span> <span class="hljs-number">10010</span><br><span class="hljs-attr">spring:</span><br><span class="hljs-attr">application:</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">api-gateway</span><br><span class="hljs-attr">eureka:</span><br><span class="hljs-attr">client:</span><br><span class="hljs-attr">service-url:</span><br><span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br><span class="hljs-attr">instance:</span><br><span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<h3 id="4-编写路由规则"><a href="#4-编写路由规则" class="headerlink" title="4.编写路由规则"></a>4.编写路由规则</h3><p>需要用网关来代理 User-service 看下当前 状态</p>
<p><img src="C:\Users\再难也会过\AppData\Roaming\Typora\typora-user-images\image-20220628110313825.png" srcset="/img/loading.gif" lazyload alt="image-20220628110313825"></p>
<p>修改网关配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br><span class="hljs-attr">port:</span> <span class="hljs-number">10010</span><br><span class="hljs-attr">spring:</span><br><span class="hljs-attr">application:</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">api-gateway</span><br><span class="hljs-attr">cloud:</span><br><span class="hljs-attr">gateway:</span><br><span class="hljs-attr">routes:</span><br><span class="hljs-comment"># 路由id，可以随意写</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user-service-route</span><br><span class="hljs-comment"># 代理的服务地址</span><br><span class="hljs-attr">uri:</span> <span class="hljs-string">http://127.0.0.1:9091</span><br><span class="hljs-comment"># 路由断言，可以配置映射路径</span><br><span class="hljs-attr">predicates:</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Path=/user/**</span>	<span class="hljs-comment">#将符合Path规则的一切请求都代理到uri参数指定的地址</span><br><span class="hljs-attr">eureka:</span><br><span class="hljs-attr">client:</span><br><span class="hljs-attr">service-url:</span><br><span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br><span class="hljs-attr">instance:</span><br><span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<h3 id="5-启动测试"><a href="#5-启动测试" class="headerlink" title="5.启动测试"></a>5.启动测试</h3><p><img src="C:\Users\再难也会过\AppData\Roaming\Typora\typora-user-images\image-20220628110532488.png" srcset="/img/loading.gif" lazyload alt="image-20220628110532488"></p>
<h2 id="spring-cloud-config"><a href="#spring-cloud-config" class="headerlink" title="spring cloud config"></a>spring cloud config</h2><p>通过修改git中的配置文件实现所有微服务的配置文件的修改</p>
<p>添加配置中心依赖</p>
<p>配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">12000</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">config-server</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">server:</span><br>        <span class="hljs-attr">git:</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">https://gitee.com/goheima/heima-config.git</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br></code></pre></td></tr></table></figure>



<p>修改service 删除application</p>
<p>创建 bootstrap.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-comment"># 要与仓库中的配置文件的application保持一致</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">user</span><br>      <span class="hljs-comment"># 要与仓库中的配置文件的profile保持一致</span><br>      <span class="hljs-attr">profile:</span> <span class="hljs-string">dev</span><br>      <span class="hljs-comment"># 要与仓库中的配置文件所属的版本（分支）一样</span><br>      <span class="hljs-attr">label:</span> <span class="hljs-string">master</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-comment"># 使用配置中心</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-comment"># 配置中心服务名</span><br>        <span class="hljs-attr">service-id:</span> <span class="hljs-string">config-server</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br></code></pre></td></tr></table></figure>



<h2 id="Bus"><a href="#Bus" class="headerlink" title="Bus"></a>Bus</h2><p>Spring Cloud Bus作用：将git仓库的配置文件更新，在不重启系统的情况下实现及时同步到各个微服务</p>
<h1 id="Spring-Cloud-Alibaba"><a href="#Spring-Cloud-Alibaba" class="headerlink" title="Spring Cloud Alibaba"></a>Spring Cloud Alibaba</h1><h1 id="Spring-Cloud-Alibaba-官方文档note"><a href="#Spring-Cloud-Alibaba-官方文档note" class="headerlink" title="Spring Cloud Alibaba 官方文档note"></a>Spring Cloud Alibaba 官方文档note</h1><blockquote>
<p>弹簧靴 &#x3D;&#x3D; spring boot</p>
<p>春云 &#x3D;&#x3D; spring cloud</p>
</blockquote>
<h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><p>Spring Cloud Alibaba 提供分布式应用开发的一站式解决方案。它包含开发分布式应用程序所需的所有组件，使您可以轻松地使用 Spring Cloud 开发应用程序。</p>
<p>使用 Spring Cloud Alibaba，您只需要添加一些注解和少量配置，即可将 Spring Cloud 应用连接到阿里巴巴的分布式解决方案，并通过阿里巴巴中间件构建分布式应用系统。</p>
<h2 id="特征"><a href="#特征" class="headerlink" title="特征"></a>特征</h2><h3 id="春云"><a href="#春云" class="headerlink" title="春云"></a>春云</h3><ul>
<li><strong>流量控制和服务降级：</strong> <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/">Alibaba Sentinel</a>的流量控制、断路和系统自适应保护</li>
<li><strong>服务注册与发现</strong>：实例可以注册到<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/">阿里巴巴的 Nacos</a>，客户端可以通过 Spring 管理的 bean 发现实例。通过 Spring Cloud Netflix 支持客户端负载均衡器 Ribbon</li>
<li><strong>分布式配置</strong>：使用<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/">阿里巴巴Nacos</a>作为数据存储</li>
<li><strong>事件驱动：构建与Spring Cloud Stream</strong> <a target="_blank" rel="noopener" href="https://rocketmq.apache.org/">RocketMQ</a> Binder连接的高度可扩展的事件驱动微服务</li>
<li><strong>Message Bus</strong> : 用 Spring Cloud Bus RocketMQ 链接分布式系统的节点</li>
<li><strong>Distributed Transaction ：支持</strong><a target="_blank" rel="noopener" href="https://github.com/seata/seata">Seata</a>高性能、易用的分布式事务解决方案</li>
<li><strong>Dubbo RPC ：通过</strong><a target="_blank" rel="noopener" href="https://dubbo.apache.org/en/">Apache Dubbo RPC</a>扩展Spring Cloud service-to-service调用的通信协议</li>
</ul>
<h3 id="弹簧靴"><a href="#弹簧靴" class="headerlink" title="弹簧靴"></a>弹簧靴</h3><p>所有的 Spring Boot Starter 都在<a target="_blank" rel="noopener" href="https://github.com/alibaba/aliyun-spring-boot">阿里云 Spring Boot Project</a>中维护。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.aliyun.com/product/oss">阿里云对象存储服务</a>Spring Boot Starter</li>
<li><a target="_blank" rel="noopener" href="https://www.aliyun.com/product/sms">阿里云短信服务</a>Spring Boot Starter</li>
<li><a target="_blank" rel="noopener" href="https://www.aliyun.com/product/kvstore">阿里云 Redis</a>的 Spring Boot Starter</li>
<li><a target="_blank" rel="noopener" href="https://www.aliyun.com/product/rds/mysql">阿里云RDS MySQL</a>的Spring Boot Starter</li>
<li><a target="_blank" rel="noopener" href="https://cn.aliyun.com/aliware/schedulerx">阿里云 SchedulerX</a>的 Spring Boot Starter</li>
</ul>
<h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><p>最简单的入门方法是包含 Spring Cloud BOM，然后添加<code>spring-cloud-alibaba-dependencies</code>到应用程序的类路径中。如果您不想包含所有 Spring Cloud Alibaba 功能，您可以为您想要的功能添加单独的启动器。</p>
<p><code>spring-cloud-alibaba-dependencies</code>pom中的依赖：</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span></span><span class="hljs-template-variable">&#123;project-version&#125;</span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>复制</span><br></code></pre></td></tr></table></figure>

<p>如果你想为阿里云服务使用 Spring Boot Starters，你应该将 Aliyun Spring Boot BOM 添加到你的 pom.xml 中：</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aliyun-spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span></span><span class="hljs-template-variable">&#123;project-version&#125;</span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span></span><br></code></pre></td></tr></table></figure>

<h2 id="nacos"><a href="#nacos" class="headerlink" title="nacos"></a>nacos</h2><h2 id="sentinel"><a href="#sentinel" class="headerlink" title="sentinel"></a>sentinel</h2><h2 id="seata"><a href="#seata" class="headerlink" title="seata"></a>seata</h2><h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="category-chain-item">微服务</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">#多线程</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>微服务</div>
      <div>https://gouguoqiang.github.io/2022/10/09/all/9MicroService/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>ggq</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年10月9日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/10/09/all/8JUC/" title="JUC">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">JUC</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/10/08/all/1java/" title="java">
                        <span class="hidden-mobile">java</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
