<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>用户登陆 &amp; JWT &amp; Oauth2.0 | ggq</title><meta name="keywords" content="JWT,Oauth2.0。"><meta name="author" content="ggq"><meta name="copyright" content="ggq"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="用户登陆 &amp; JWT &amp; Oauth2.0模块。">
<meta property="og:type" content="article">
<meta property="og:title" content="用户登陆 &amp; JWT &amp; Oauth2.0">
<meta property="og:url" content="https://gouguoqiang.github.io/2022/09/01/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E/%E7%94%A8%E6%88%B7%E7%99%BB%E9%99%86%20&%20JWT%20&%20Oauth2.0/index.html">
<meta property="og:site_name" content="ggq">
<meta property="og:description" content="用户登陆 &amp; JWT &amp; Oauth2.0模块。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-09-01T03:51:56.000Z">
<meta property="article:modified_time" content="2022-10-17T13:02:39.179Z">
<meta property="article:author" content="ggq">
<meta property="article:tag" content="商城">
<meta name="twitter:card" content="summary"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://gouguoqiang.github.io/2022/09/01/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E/%E7%94%A8%E6%88%B7%E7%99%BB%E9%99%86%20&amp;%20JWT%20&amp;%20Oauth2.0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '用户登陆 & JWT & Oauth2.0',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-17 21:02:39'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">78</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">19</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ggq</a></span><div id="menus"><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">用户登陆 &amp; JWT &amp; Oauth2.0</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-09-01T03:51:56.000Z" title="发表于 2022-09-01 11:51:56">2022-09-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-17T13:02:39.179Z" title="更新于 2022-10-17 21:02:39">2022-10-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/">畅购商城项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="用户登陆 &amp; JWT &amp; Oauth2.0"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="3-用户登录"><a href="#3-用户登录" class="headerlink" title="3 用户登录"></a>3 用户登录</h2><p>项目中有2个重要角色，分别为管理员和用户，下面几章我们将实现购物下单和支付，用户如果没登录是没法下单和支付的，所以我们这里需要实现一个登录功能。</p>
<h3 id="3-1-表结构介绍"><a href="#3-1-表结构介绍" class="headerlink" title="3.1 表结构介绍"></a>3.1 表结构介绍</h3><p>changgou_user表如下：</p>
<p><img src="/../../images/1562050583653.png" alt="1562050583653"></p>
<p>用户信息表tb_user</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_user` (</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;密码，加密存储&#x27;</span>,</span><br><span class="line">  `phone` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;注册手机号&#x27;</span>,</span><br><span class="line">  `email` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;注册邮箱&#x27;</span>,</span><br><span class="line">  `created` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `updated` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `source_type` <span class="type">varchar</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;会员来源：1:PC，2：H5，3：Android，4：IOS&#x27;</span>,</span><br><span class="line">  `nick_name` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;昵称&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;真实姓名&#x27;</span>,</span><br><span class="line">  `status` <span class="type">varchar</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;使用状态（1正常 0非正常）&#x27;</span>,</span><br><span class="line">  `head_pic` <span class="type">varchar</span>(<span class="number">150</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;头像地址&#x27;</span>,</span><br><span class="line">  `qq` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;QQ号码&#x27;</span>,</span><br><span class="line">  `is_mobile_check` <span class="type">varchar</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;手机是否验证 （0否  1是）&#x27;</span>,</span><br><span class="line">  `is_email_check` <span class="type">varchar</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;邮箱是否检测（0否  1是）&#x27;</span>,</span><br><span class="line">  `sex` <span class="type">varchar</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;性别，1男，0女&#x27;</span>,</span><br><span class="line">  `user_level` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;会员等级&#x27;</span>,</span><br><span class="line">  `points` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;积分&#x27;</span>,</span><br><span class="line">  `experience_value` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;经验值&#x27;</span>,</span><br><span class="line">  `birthday` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;出生年月日&#x27;</span>,</span><br><span class="line">  `last_login_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;最后登录时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`username`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `username` (`username`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;用户表&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-用户微服务创建"><a href="#3-2-用户微服务创建" class="headerlink" title="3.2 用户微服务创建"></a>3.2 用户微服务创建</h3><p>创建工程之前，先使用代码生成器生成对应的业务代码。</p>
<p>(1)公共API创建</p>
<p>在changgou-service-api中创建changgou-service-user-api，并将pojo拷贝到工程中，如下图：</p>
<p><img src="/../../images/1562051835630.png" alt="1562051835630"></p>
<p>在changgou-service中创建changgou-service-user微服务,并引入生成的业务逻辑代码，如下图：</p>
<p><img src="/../../images/1562051932945.png" alt="1562051932945"></p>
<p>(2)依赖</p>
<p>在changgou-service-user的pom.xml引入如下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.changgou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-service-user<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.changgou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-service-user-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>(3)启动类创建</p>
<p>在changgou-service-user微服务中创建启动类com.changgou.UserApplication，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.changgou.user.dao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(UserApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>(4)application.yml配置</p>
<p>在changgou-service-user的resources中创建application.yml配置，代码如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">18089</span></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">user</span></span><br><span class="line">  <span class="attr">datasource</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">driver-class-name</span>: <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url</span>: <span class="string">jdbc:mysql://192.168.211.132:3306/changgou_user?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username</span>: <span class="string">root</span></span><br><span class="line">    <span class="attr">password</span>: <span class="string">123456</span></span><br><span class="line"><span class="attr">eureka</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">service-url</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">defaultZone</span>: <span class="string">http://127.0.0.1:7001/eureka</span></span><br><span class="line">  <span class="attr">instance</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">prefer-ip-address</span>: <span class="string">true</span></span><br><span class="line"><span class="attr">feign</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">hystrix</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">enabled</span>: <span class="string">true</span></span><br></pre></td></tr></table></figure>





<h3 id="3-3-登录"><a href="#3-3-登录" class="headerlink" title="3.3 登录"></a>3.3 登录</h3><p>登录的时候，需要进行密码校验，这里采用了BCryptPasswordEncoder进行加密，需要将资料中的BCrypt导入到common工程中，其中BCrypt.checkpw(“明文”,”密文”)用于对比密码是否一致。</p>
<p>修改changgou-service-user的com.changgou.user.controller.UserController添加登录方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 用户登录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(String username,String password)</span>&#123;</span><br><span class="line">    <span class="comment">//查询用户信息</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findById(username);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user!=<span class="literal">null</span> &amp;&amp; BCrypt.checkpw(password,user.getPassword()))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="literal">true</span>,StatusCode.OK,<span class="string">&quot;登录成功！&quot;</span>,user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="literal">false</span>,StatusCode.LOGINERROR,<span class="string">&quot;账号或者密码错误！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：这里密码进行了加密。</p>
<p>使用Postman测试如下：</p>
<p><img src="/../../images/1562054405004.png" alt="1562054405004"></p>
<h3 id="3-4-网关关联"><a href="#3-4-网关关联" class="headerlink" title="3.4 网关关联"></a>3.4 网关关联</h3><p><img src="/../../images/1562055045607.png" alt="1562055045607"></p>
<p>在我们平时工作中，并不会直接将微服务暴露出去，一般都会使用网关对接，实现对微服务的一个保护作用，如上图，当用户访问<code>/api/user/</code>的时候我们再根据用户请求调用用户微服务的指定方法。当然，除了<code>/api/user/</code>还有<code>/api/address/</code>、<code>/api/areas/</code>、<code>/api/cities/</code>、<code>/api/provinces/</code>都需要由user微服务处理，修改网关工程<code>changgou-gateway-web</code>的application.yml配置文件，如下代码：</p>
<p><img src="/../../images/1562055618797.png" alt="1562055618797"></p>
<p>上图代码如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">cloud</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">gateway</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">globalcors</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">corsConfigurations</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">&#x27;[/**]&#x27;</span>: <span class="string"># 匹配所有请求</span></span><br><span class="line">              <span class="attr">allowedOrigins</span>: <span class="string">&quot;*&quot; #跨域处理 允许所有的域</span></span><br><span class="line">              <span class="attr">allowedMethods</span>: <span class="string"># 支持的方法</span></span><br><span class="line">                <span class="attr">-</span> <span class="string">GET</span></span><br><span class="line">                <span class="attr">-</span> <span class="string">POST</span></span><br><span class="line">                <span class="attr">-</span> <span class="string">PUT</span></span><br><span class="line">                <span class="attr">-</span> <span class="string">DELETE</span></span><br><span class="line">      <span class="attr">routes</span>:<span class="string"></span></span><br><span class="line">            <span class="attr">-</span> <span class="string">id: changgou_goods_route</span></span><br><span class="line">              <span class="attr">uri</span>: <span class="string">lb://goods</span></span><br><span class="line">              <span class="attr">predicates</span>:<span class="string"></span></span><br><span class="line">              <span class="attr">-</span> <span class="string">Path=/api/goods/**</span></span><br><span class="line">              <span class="attr">filters</span>:<span class="string"></span></span><br><span class="line">              <span class="attr">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">              <span class="attr">-</span> <span class="string">name: RequestRateLimiter #请求数限流 名字不能随便写 ，使用默认的facatory</span></span><br><span class="line">                <span class="attr">args</span>:<span class="string"></span></span><br><span class="line">                  <span class="attr">key-resolver</span>: <span class="string">&quot;#&#123;@ipKeyResolver&#125;&quot;</span></span><br><span class="line">                  <span class="attr">redis-rate-limiter.replenishRate</span>: <span class="string">1</span></span><br><span class="line">                  <span class="attr">redis-rate-limiter.burstCapacity</span>: <span class="string">1</span></span><br><span class="line"><span class="comment">            #用户微服务</span></span><br><span class="line">            <span class="attr">-</span> <span class="string">id: changgou_user_route</span></span><br><span class="line">              <span class="attr">uri</span>: <span class="string">lb://user</span></span><br><span class="line">              <span class="attr">predicates</span>:<span class="string"></span></span><br><span class="line">              <span class="attr">-</span> <span class="string">Path=/api/user/**,/api/address/**,/api/areas/**,/api/cities/**,/api/provinces/**</span></span><br><span class="line">              <span class="attr">filters</span>:<span class="string"></span></span><br><span class="line">              <span class="attr">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">gateway-web</span></span><br><span class="line"><span class="comment">  #Redis配置</span></span><br><span class="line">  <span class="attr">redis</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">host</span>: <span class="string">192.168.211.132</span></span><br><span class="line">    <span class="attr">port</span>: <span class="string">6379</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">8001</span></span><br><span class="line"><span class="attr">eureka</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">service-url</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">defaultZone</span>: <span class="string">http://127.0.0.1:7001/eureka</span></span><br><span class="line">  <span class="attr">instance</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">prefer-ip-address</span>: <span class="string">true</span></span><br><span class="line"><span class="attr">management</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">endpoint</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">gateway</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">enabled</span>: <span class="string">true</span></span><br><span class="line">    <span class="attr">web</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">exposure</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">include</span>: <span class="string">true</span></span><br></pre></td></tr></table></figure>



<p>使用Postman访问<code>http://localhost:8001/api/user/login?username=changgou&amp;password=changgou</code>，效果如下：</p>
<p><img src="/../../images/1562055882671.png" alt="1562055882671"></p>
<h2 id="4-JWT讲解"><a href="#4-JWT讲解" class="headerlink" title="4 JWT讲解"></a>4 JWT讲解</h2><h3 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1 需求分析"></a>4.1 需求分析</h3><p>我们之前已经搭建过了网关，使用网关在网关系统中比较适合进行权限校验。</p>
<p><img src="/../../images/1562059385713.png" alt="1562059385713"></p>
<p>那么我们可以采用JWT的方式来实现鉴权校验。</p>
<h3 id="4-2-什么是JWT"><a href="#4-2-什么是JWT" class="headerlink" title="4.2 什么是JWT"></a>4.2 什么是JWT</h3><p>JSON Web Token（JWT）是一个非常轻巧的规范。这个规范允许我们使用JWT在用户和服务器之间传递安全可靠的信息。</p>
<h3 id="4-3-JWT的构成"><a href="#4-3-JWT的构成" class="headerlink" title="4.3 JWT的构成"></a>4.3 JWT的构成</h3><p>头部描述信息,+载荷生成base64相当于明文,在加盐签名,盗了怎么办,服务端签发了JWT后用户就可</p>
<ol>
<li>JWT本身包含认证信息，因此一旦信息泄露，任何人都可以获得令牌的所有权限。为了减少盗用，JWT的有效期不宜设置太长。对于某些重要操作，用户在使用时应该每次都进行进行身份验证。</li>
<li>为了减少盗用和窃取，JWT不建议使用HTTP协议来传输代码，而是使用加密的HTTPS协议进行传输。</li>
</ol>
<p>一个JWT实际上就是一个字符串，它由三部分组成，头部、载荷与签名。\</p>
<p><img src="/../../images/image-20220715230940638.png" alt="image-20220715230940638">                                                        </p>
<p><strong>头部（Header）</strong></p>
<p>头部用于描述关于该JWT的最基本的信息，例如其类型以及签名所用的算法等。这也可以被表示成一个JSON对象。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;typ&quot;</span><span class="punctuation">:</span><span class="string">&quot;JWT&quot;</span><span class="punctuation">,</span><span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span><span class="string">&quot;HS256&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在头部指明了签名算法是HS256算法。 我们进行BASE64编码<a target="_blank" rel="noopener" href="http://base64.xpcha.com/%EF%BC%8C%E7%BC%96%E7%A0%81%E5%90%8E%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A6%82%E4%B8%8B%EF%BC%9A">http://base64.xpcha.com/，编码后的字符串如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</span><br></pre></td></tr></table></figure>

<blockquote>
<p>小知识：Base64是一种基于64个可打印字符来表示二进制数据的表示方法。由于2的6次方等于64，所以每6个比特为一个单元，对应某个可打印字符。三个字节有24个比特，对应于4个Base64单元，即3个字节需要用4个可打印字符来表示。JDK 中提供了非常方便的 <strong>BASE64Encoder</strong> 和 <strong>BASE64Decoder</strong>，用它们可以非常方便的完成基于 BASE64 的编码和解码</p>
</blockquote>
<p><strong>载荷（playload）</strong></p>
<p>载荷就是存放有效信息的地方。这个名字像是特指飞机上承载的货品，这些有效信息包含三个部分</p>
<p>（1）标准中注册的声明（建议但不强制使用）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iss: jwt签发者</span><br><span class="line">sub: jwt所面向的用户</span><br><span class="line">aud: 接收jwt的一方</span><br><span class="line">exp: jwt的过期时间，这个过期时间必须要大于签发时间</span><br><span class="line">nbf: 定义在什么时间之前，该jwt都是不可用的.</span><br><span class="line">iat: jwt的签发时间</span><br><span class="line">jti: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</span><br></pre></td></tr></table></figure>

<p>（2）公共的声明</p>
<p>公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密.   </p>
<p>（3）私有的声明</p>
<p>私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。</p>
<p>这个指的就是自定义的claim。比如下面面结构举例中的admin和name都属于自定的claim。这些claim跟JWT标准规定的claim区别在于：JWT规定的claim，JWT的接收方在拿到JWT之后，都知道怎么对这些标准的claim进行验证(还不知道是否能够验证)；而private claims不会验证，除非明确告诉接收方要对这些claim进行验证以及规则才行。</p>
<p>定义一个payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;sub&quot;:&quot;1234567890&quot;,&quot;name&quot;:&quot;John Doe&quot;,&quot;admin&quot;:true&#125;</span><br></pre></td></tr></table></figure>

<p>然后将其进行base64加密，得到Jwt的第二部分。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9</span><br></pre></td></tr></table></figure>

<p><strong>签证（signature）</strong></p>
<p>jwt的第三部分是一个签证信息，这个签证信息由三部分组成：</p>
<blockquote>
<p>header (base64后的)</p>
<p>payload (base64后的)</p>
<p>secret</p>
</blockquote>
<p>这个部分需要base64加密后的header和base64加密后的payload使用.连接组成的字符串，然后通过header中声明的加密方式进行加盐secret组合加密，然后就构成了jwt的第三部分。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</span><br></pre></td></tr></table></figure>

<p>将这三部分用.连接成一个完整的字符串,构成了最终的jwt:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：secret是保存在服务器端的，jwt的签发生成也是在服务器端的，secret就是用来进行jwt的签发和jwt的验证，所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个secret, 那就意味着客户端是可以自我签发jwt了。</p>
<h3 id="4-4-JJWT的介绍和使用"><a href="#4-4-JJWT的介绍和使用" class="headerlink" title="4.4 JJWT的介绍和使用"></a>4.4 JJWT的介绍和使用</h3><p>JJWT是一个提供端到端的JWT创建和验证的Java库。永远免费和开源(Apache License，版本2.0)，JJWT很容易使用和理解。它被设计成一个以建筑为中心的流畅界面，隐藏了它的大部分复杂性。</p>
<p>官方文档：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jwtk/jjwt">https://github.com/jwtk/jjwt</a></p>
<h4 id="4-4-1-创建TOKEN"><a href="#4-4-1-创建TOKEN" class="headerlink" title="4.4.1 创建TOKEN"></a>4.4.1 创建TOKEN</h4><p>(1)依赖引入</p>
<p>在changgou-parent项目中的pom.xml中添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--鉴权--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>(2)创建测试</p>
<p>在changgou-common的&#x2F;test&#x2F;java下创建测试类，并设置测试方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/****</span></span><br><span class="line"><span class="comment">     * 创建Jwt令牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCreateJwt</span><span class="params">()</span>&#123;</span><br><span class="line">        JwtBuilder builder= Jwts.builder()</span><br><span class="line">                .setId(<span class="string">&quot;888&quot;</span>)             <span class="comment">//设置唯一编号</span></span><br><span class="line">                .setSubject(<span class="string">&quot;小白&quot;</span>)       <span class="comment">//设置主题  可以是JSON数据</span></span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>())  <span class="comment">//设置签发日期</span></span><br><span class="line">                .signWith(SignatureAlgorithm.HS256,<span class="string">&quot;itcast&quot;</span>);<span class="comment">//设置签名 使用HS256算法，并设置SecretKey(字符串)</span></span><br><span class="line">        <span class="comment">//构建 并返回一个字符串</span></span><br><span class="line">        System.out.println( builder.compact() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行打印结果：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjIyODd9.RBLpZ79USMplQyfJCZFD2muHV_KLks7M1ZsjTu6Aez4</span></span><br></pre></td></tr></table></figure>

<p>再次运行，会发现每次运行的结果是不一样的，因为我们的载荷中包含了时间。</p>
<h4 id="4-4-2-TOKEN解析"><a href="#4-4-2-TOKEN解析" class="headerlink" title="4.4.2 TOKEN解析"></a>4.4.2 TOKEN解析</h4><p>我们刚才已经创建了token ，在web应用中这个操作是由服务端进行然后发给客户端，客户端在下次向服务端发送请求时需要携带这个token（这就好像是拿着一张门票一样），那服务端接到这个token 应该解析出token中的信息（例如用户id）,根据这些信息查询数据库返回相应的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 解析Jwt令牌数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testParseJwt</span><span class="params">()</span>&#123;</span><br><span class="line">    String compactJwt=<span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjIyODd9.RBLpZ79USMplQyfJCZFD2muHV_KLks7M1ZsjTu6Aez4&quot;</span>;</span><br><span class="line">    <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.parser().</span><br><span class="line">            setSigningKey(<span class="string">&quot;itcast&quot;</span>).</span><br><span class="line">            parseClaimsJws(compactJwt).</span><br><span class="line">            getBody();</span><br><span class="line">    System.out.println(claims);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行打印效果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;jti=888, sub=小白, iat=1562062287&#125;</span><br></pre></td></tr></table></figure>

<p>试着将token或签名秘钥篡改一下，会发现运行时就会报错，所以解析token也就是验证token.</p>
<h4 id="4-4-3-设置过期时间"><a href="#4-4-3-设置过期时间" class="headerlink" title="4.4.3 设置过期时间"></a>4.4.3 设置过期时间</h4><p>有很多时候，我们并不希望签发的token是永久生效的，所以我们可以为token添加一个过期时间。</p>
<h5 id="4-4-3-1-token过期设置"><a href="#4-4-3-1-token过期设置" class="headerlink" title="4.4.3.1 token过期设置"></a>4.4.3.1 token过期设置</h5><p><img src="/../../images/1562062896413.png" alt="1562062896413"></p>
<p>解释：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">.setExpiration(date)//用于设置过期时间</span> <span class="string">，参数为Date类型数据</span></span><br></pre></td></tr></table></figure>

<p>运行，打印效果如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjI5MjUsImV4cCI6MTU2MjA2MjkyNX0._vs4METaPkCza52LuN0-2NGGWIIO7v51xt40DHY1U1Q</span></span><br></pre></td></tr></table></figure>



<h5 id="4-4-3-2-解析TOKEN"><a href="#4-4-3-2-解析TOKEN" class="headerlink" title="4.4.3.2 解析TOKEN"></a>4.4.3.2 解析TOKEN</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 解析Jwt令牌数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testParseJwt</span><span class="params">()</span>&#123;</span><br><span class="line">    String compactJwt=<span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjI5MjUsImV4cCI6MTU2MjA2MjkyNX0._vs4METaPkCza52LuN0-2NGGWIIO7v51xt40DHY1U1Q&quot;</span>;</span><br><span class="line">    <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.parser().</span><br><span class="line">            setSigningKey(<span class="string">&quot;itcast&quot;</span>).</span><br><span class="line">            parseClaimsJws(compactJwt).</span><br><span class="line">            getBody();</span><br><span class="line">    System.out.println(claims);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印效果：</p>
<p><img src="/../../images/1562063075099.png" alt="1562063075099"></p>
<p>当前时间超过过期时间，则会报错。</p>
<h4 id="4-4-4-自定义claims"><a href="#4-4-4-自定义claims" class="headerlink" title="4.4.4 自定义claims"></a>4.4.4 自定义claims</h4><p>我们刚才的例子只是存储了id和subject两个信息，如果你想存储更多的信息（例如角色）可以定义自定义claims。</p>
<p>创建测试类，并设置测试方法：</p>
<p>创建token:</p>
<p><img src="/../../images/1562063346685.png" alt="1562063346685"></p>
<p>运行打印效果：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjMyOTIsImFkZHJlc3MiOiLmt7HlnLPpu5Hpqazorq3nu4PokKXnqIvluo_lkZjkuK3lv4MiLCJuYW1lIjoi546L5LqUIiwiYWdlIjoyN30.ZSbHt5qrxz0F1Ma9rVHHAIy4jMCBGIHoNaaPQXxV_dk</span></span><br></pre></td></tr></table></figure>



<p>解析TOKEN:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 解析Jwt令牌数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testParseJwt</span><span class="params">()</span>&#123;</span><br><span class="line">    String compactJwt=<span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjMyOTIsImFkZHJlc3MiOiLmt7HlnLPpu5Hpqazorq3nu4PokKXnqIvluo_lkZjkuK3lv4MiLCJuYW1lIjoi546L5LqUIiwiYWdlIjoyN30.ZSbHt5qrxz0F1Ma9rVHHAIy4jMCBGIHoNaaPQXxV_dk&quot;</span>;</span><br><span class="line">    <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.parser().</span><br><span class="line">            setSigningKey(<span class="string">&quot;itcast&quot;</span>).</span><br><span class="line">            parseClaimsJws(compactJwt).</span><br><span class="line">            getBody();</span><br><span class="line">    System.out.println(claims);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行效果：</p>
<p><img src="/../../images/1562063412350.png" alt="1562063412350"></p>
<h3 id="4-5-鉴权处理"><a href="#4-5-鉴权处理" class="headerlink" title="4.5 鉴权处理"></a>4.5 鉴权处理</h3><h4 id="4-5-1-思路分析"><a href="#4-5-1-思路分析" class="headerlink" title="4.5.1 思路分析"></a>4.5.1 思路分析</h4><p><img src="/../../images/1562069596308.png" alt="1562069596308"></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.用户通过访问微服务网关调用微服务，同时携带头文件信息</span></span><br><span class="line"><span class="attr">2.在微服务网关这里进行拦截，拦截后获取用户要访问的路径</span></span><br><span class="line"><span class="attr">3.识别用户访问的路径是否需要登录，如果需要，识别用户的身份是否能访问该路径[这里可以基于数据库设计一套权限]</span></span><br><span class="line"><span class="attr">4.如果需要权限访问，用户已经登录，则放行</span></span><br><span class="line"><span class="attr">5.如果需要权限访问，且用户未登录，则提示用户需要登录</span></span><br><span class="line"><span class="attr">6.用户通过网关访问用户微服务，进行登录验证</span></span><br><span class="line"><span class="attr">7.验证通过后，用户微服务会颁发一个令牌给网关，网关会将用户信息封装到头文件中，并响应用户</span></span><br><span class="line"><span class="attr">8.用户下次访问，携带头文件中的令牌信息即可识别是否登录</span></span><br></pre></td></tr></table></figure>



<h4 id="4-5-2用户登录签发TOKEN"><a href="#4-5-2用户登录签发TOKEN" class="headerlink" title="4.5.2用户登录签发TOKEN"></a>4.5.2用户登录签发TOKEN</h4><p>(1)生成令牌工具类</p>
<p>在changgou-common中创建类entity.JwtUtil，主要辅助生成Jwt令牌信息，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//有效期为</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">JWT_TTL</span> <span class="operator">=</span> <span class="number">3600000L</span>;<span class="comment">// 60 * 60 *1000  一个小时</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Jwt令牌信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JWT_KEY</span> <span class="operator">=</span> <span class="string">&quot;itcast&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">createJWT</span><span class="params">(String id, String subject, Long ttlMillis)</span> &#123;</span><br><span class="line">        <span class="comment">//指定算法</span></span><br><span class="line">        <span class="type">SignatureAlgorithm</span> <span class="variable">signatureAlgorithm</span> <span class="operator">=</span> SignatureAlgorithm.HS256;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//当前系统时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">nowMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//令牌签发时间</span></span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(nowMillis);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果令牌有效期为null，则默认设置有效期1小时</span></span><br><span class="line">        <span class="keyword">if</span>(ttlMillis==<span class="literal">null</span>)&#123;</span><br><span class="line">            ttlMillis=JwtUtil.JWT_TTL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//令牌过期时间设置</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">expMillis</span> <span class="operator">=</span> nowMillis + ttlMillis;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">expDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(expMillis);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成秘钥</span></span><br><span class="line">        <span class="type">SecretKey</span> <span class="variable">secretKey</span> <span class="operator">=</span> generalKey();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//封装Jwt令牌信息</span></span><br><span class="line">        <span class="type">JwtBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                .setId(id)                    <span class="comment">//唯一的ID</span></span><br><span class="line">                .setSubject(subject)          <span class="comment">// 主题  可以是JSON数据</span></span><br><span class="line">                .setIssuer(<span class="string">&quot;admin&quot;</span>)          <span class="comment">// 签发者</span></span><br><span class="line">                .setIssuedAt(now)             <span class="comment">// 签发时间</span></span><br><span class="line">                .signWith(signatureAlgorithm, secretKey) <span class="comment">// 签名算法以及密匙</span></span><br><span class="line">                .setExpiration(expDate);      <span class="comment">// 设置过期时间</span></span><br><span class="line">        <span class="keyword">return</span> builder.compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成加密 secretKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SecretKey <span class="title function_">generalKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] encodedKey = Base64.getEncoder().encode(JwtUtil.JWT_KEY.getBytes());</span><br><span class="line">        <span class="type">SecretKey</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(encodedKey, <span class="number">0</span>, encodedKey.length, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析令牌数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Claims <span class="title function_">parseJWT</span><span class="params">(String jwt)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SecretKey</span> <span class="variable">secretKey</span> <span class="operator">=</span> generalKey();</span><br><span class="line">        <span class="keyword">return</span> Jwts.parser()</span><br><span class="line">                .setSigningKey(secretKey)</span><br><span class="line">                .parseClaimsJws(jwt)</span><br><span class="line">                .getBody();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>(2) 用户登录成功 则 签发TOKEN，修改登录的方法：</p>
<p><img src="/../../images/1562070521132.png" alt="1562070521132"></p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 用户登录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(String username,String password)</span>&#123;</span><br><span class="line">    <span class="comment">//查询用户信息</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findById(username);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user!=<span class="literal">null</span> &amp;&amp; BCrypt.checkpw(password,user.getPassword()))&#123;</span><br><span class="line">        <span class="comment">//设置令牌信息</span></span><br><span class="line">        Map&lt;String,Object&gt; info = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,Object&gt;();</span><br><span class="line">        info.put(<span class="string">&quot;role&quot;</span>,<span class="string">&quot;USER&quot;</span>);</span><br><span class="line">        info.put(<span class="string">&quot;success&quot;</span>,<span class="string">&quot;SUCCESS&quot;</span>);</span><br><span class="line">        info.put(<span class="string">&quot;username&quot;</span>,username);</span><br><span class="line">        <span class="comment">//生成令牌</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> JwtUtil.createJWT(UUID.randomUUID().toString(), JSON.toJSONString(info),<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="literal">true</span>,StatusCode.OK,<span class="string">&quot;登录成功！&quot;</span>,jwt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="literal">false</span>,StatusCode.LOGINERROR,<span class="string">&quot;账号或者密码错误！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-5-3-网关过滤器拦截请求处理"><a href="#4-5-3-网关过滤器拦截请求处理" class="headerlink" title="4.5.3 网关过滤器拦截请求处理"></a>4.5.3 网关过滤器拦截请求处理</h4><p>拷贝JwtUtil到changgou-gateway-web中</p>
<p><img src="/../../images/1562116408008.png" alt="1562116408008"></p>
<h4 id="4-5-4-自定义全局过滤器"><a href="#4-5-4-自定义全局过滤器" class="headerlink" title="4.5.4 自定义全局过滤器"></a>4.5.4 自定义全局过滤器</h4><p>创建 过滤器类，如图所示：</p>
<p><img src="/../../images/1562116467343.png" alt="1562116467343"></p>
<p>AuthorizeFilter代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizeFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//令牌头名字</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AUTHORIZE_TOKEN</span> <span class="operator">=</span> <span class="string">&quot;Authorization&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 全局过滤器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chain</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">//获取Request、Response对象</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取请求的URI</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> request.getURI().getPath();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果是登录、goods等开放的微服务[这里的goods部分开放],则直接放行,这里不做完整演示，完整演示需要设计一套权限系统</span></span><br><span class="line">        <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;/api/user/login&quot;</span>) || path.startsWith(<span class="string">&quot;/api/brand/search/&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">//放行</span></span><br><span class="line">            Mono&lt;Void&gt; filter = chain.filter(exchange);</span><br><span class="line">            <span class="keyword">return</span> filter;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取头文件中的令牌信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tokent</span> <span class="operator">=</span> request.getHeaders().getFirst(AUTHORIZE_TOKEN);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果头文件中没有，则从请求参数中获取</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(tokent)) &#123;</span><br><span class="line">            tokent = request.getQueryParams().getFirst(AUTHORIZE_TOKEN);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果为空，则输出错误代码</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(tokent)) &#123;</span><br><span class="line">            <span class="comment">//设置方法不允许被访问，405错误代码</span></span><br><span class="line">           response.setStatusCode(HttpStatus.METHOD_NOT_ALLOWED);</span><br><span class="line">           <span class="keyword">return</span> response.setComplete();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解析令牌数据</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(tokent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">//解析失败，响应401错误</span></span><br><span class="line">            response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> response.setComplete();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 过滤器执行顺序</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="4-5-5-配置过滤规则"><a href="#4-5-5-配置过滤规则" class="headerlink" title="4.5.5 配置过滤规则"></a>4.5.5 配置过滤规则</h4><p>修改网关系统的yml文件：</p>
<p><img src="/../../images/1562117570398.png" alt="1562117570398"></p>
<p>上述代码如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span></span><br><span class="line">        <span class="attr">corsConfigurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span> <span class="comment"># 匹配所有请求</span></span><br><span class="line">              <span class="attr">allowedOrigins:</span> <span class="string">&quot;*&quot;</span> <span class="comment">#跨域处理 允许所有的域</span></span><br><span class="line">              <span class="attr">allowedMethods:</span> <span class="comment"># 支持的方法</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">GET</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">POST</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">PUT</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">DELETE</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">changgou_goods_route</span></span><br><span class="line">              <span class="attr">uri:</span> <span class="string">lb://goods</span></span><br><span class="line">              <span class="attr">predicates:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">Path=/api/album/**,/api/brand/**,/api/cache/**,/api/categoryBrand/**,/api/category/**,/api/para/**,/api/pref/**,/api/sku/**,/api/spec/**,/api/spu/**,/api/stockBack/**,/api/template/**</span></span><br><span class="line">              <span class="attr">filters:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RequestRateLimiter</span> <span class="comment">#请求数限流 名字不能随便写 ，使用默认的facatory</span></span><br><span class="line">                <span class="attr">args:</span></span><br><span class="line">                  <span class="attr">key-resolver:</span> <span class="string">&quot;#&#123;@ipKeyResolver&#125;&quot;</span></span><br><span class="line">                  <span class="attr">redis-rate-limiter.replenishRate:</span> <span class="number">1</span></span><br><span class="line">                  <span class="attr">redis-rate-limiter.burstCapacity:</span> <span class="number">1</span></span><br><span class="line">            <span class="comment">#用户微服务</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">changgou_user_route</span></span><br><span class="line">              <span class="attr">uri:</span> <span class="string">lb://user</span></span><br><span class="line">              <span class="attr">predicates:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">Path=/api/user/**,/api/address/**,/api/areas/**,/api/cities/**,/api/provinces/**</span></span><br><span class="line">              <span class="attr">filters:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-web</span></span><br><span class="line">  <span class="comment">#Redis配置</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.211</span><span class="number">.132</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:7001/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>测试访问<code>http://localhost:8001/api/user/login?username=changgou&amp;password=changgou</code>，效果如下：</p>
<p><img src="/../../images/1562117166529.png" alt="1562117166529"></p>
<p>测试访问<code>http://localhost:8001/api/user</code>，效果如下：</p>
<p><img src="/../../images/1562117230885.png" alt="1562117230885"></p>
<p>参考官方手册：</p>
<p><a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#_stripprefix_gatewayfilter_factory">https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#_stripprefix_gatewayfilter_factory</a></p>
<h3 id="4-6-会话保持"><a href="#4-6-会话保持" class="headerlink" title="4.6 会话保持"></a>4.6 会话保持</h3><p>用户每次请求的时候，我们都需要获取令牌数据，方法有多重，可以在每次提交的时候，将数据提交到头文件中，也可以将数据存储到Cookie中，每次从Cookie中校验数据，还可以每次将令牌数据以参数的方式提交到网关，这里面采用Cookie的方式比较容易实现。</p>
<h4 id="4-6-1-登录封装Cookie"><a href="#4-6-1-登录封装Cookie" class="headerlink" title="4.6.1 登录封装Cookie"></a>4.6.1 登录封装Cookie</h4><p>修改user微服务，每次登录的时候，添加令牌信息到Cookie中，修改changgou-service-user的<code>com.changgou.user.controller.UserController</code>的<code>login</code>方法，代码如下：</p>
<p><img src="/../../images/1562120506682.png" alt="1562120506682"></p>
<h4 id="4-6-2-过滤器获取令牌数据"><a href="#4-6-2-过滤器获取令牌数据" class="headerlink" title="4.6.2 过滤器获取令牌数据"></a>4.6.2 过滤器获取令牌数据</h4><p>每次在网关中通过过滤器获取Cookie中的令牌，然后对令牌数据进行解析，修改微服务网关changgou-gateway-web中的AuthorizeFilter，代码如下：</p>
<p><img src="/../../images/1562120763383.png" alt="1562120763383"></p>
<p>登录后测试，可以识别用户身份，不登录无法识别。如下访问<code>http://localhost:8001/api/user</code>会携带令牌数据：</p>
<p><img src="/../../images/1562121093670.png" alt="1562121093670"></p>
<h4 id="4-6-3-添加Header信息"><a href="#4-6-3-添加Header信息" class="headerlink" title="4.6.3 添加Header信息"></a>4.6.3 添加Header信息</h4><p>我们还可以在Gateway的全局过滤器中添加请求头信息，例如可以讲令牌信息添加到请求头中，在微服务中获取头信息，如下代码：</p>
<p>修改微服务网关中的AuthorizeFilter过滤器，在令牌信息校验那块将令牌加入到请求头中，如下代码：</p>
<p><img src="/../../images/1562243515236.png" alt="1562243515236"></p>
<p>在changgou-service-user微服务的UserController的findAll方法中获取请求头测试，代码如下：</p>
<p><img src="/../../images/1562243608017.png" alt="1562243608017"></p>
<p>后台输出令牌数据如下：</p>
<p><img src="/../../images/1562243685686.png" alt="1562243685686"></p>
<p>不存储密码明文而是密文</p>
<h2 id="2-认证技术方案"><a href="#2-认证技术方案" class="headerlink" title="2 认证技术方案"></a>2 认证技术方案</h2><h3 id="2-1-单点登录技术方案"><a href="#2-1-单点登录技术方案" class="headerlink" title="2.1 单点登录技术方案"></a>2.1 单点登录技术方案</h3><p>分布式系统要实现单点登录，通常将认证系统独立抽取出来，并且将用户身份信息存储在单独的存储介质，比如： MySQL、Redis，考虑性能要求，通常存储在Redis中，如下图：</p>
<p><img src="/../../images/1558175040643.png" alt="1558175040643"></p>
<p>单点登录的特点是： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、认证系统为独立的系统。 </span><br><span class="line">2、各子系统通过Http或其它协议与认证系统通信，完成用户认证。 </span><br><span class="line">3、用户身份信息存储在Redis集群。</span><br></pre></td></tr></table></figure>

<p> Java中有很多用户认证的框架都可以实现单点登录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、Apache Shiro. </span><br><span class="line">2、CAS </span><br><span class="line">3、Spring security CAS    </span><br></pre></td></tr></table></figure>



<h2 id="Oauth2-0"><a href="#Oauth2-0" class="headerlink" title="Oauth2.0"></a>Oauth2.0</h2><p><img src="file://D:/git-demo/%E7%95%85%E8%B4%AD-%E8%AE%B2%E5%B8%88%E6%BA%90%E7%A0%81md%E8%AF%BE%E4%BB%B6/day09Oauth2%20JWT/%E8%AE%B2%E4%B9%89/images/1562394786067.png?lastModify=1660700392" alt="1562394786067"></p>
<h3 id="2-3-Spring-security-Oauth2认证解决方案"><a href="#2-3-Spring-security-Oauth2认证解决方案" class="headerlink" title="2.3 Spring security Oauth2认证解决方案"></a>2.3 Spring security Oauth2认证解决方案</h3><p>本项目采用 Spring security + Oauth2完成用户认证及用户授权，Spring security 是一个强大的和高度可定制的身份验证和访问控制框架，Spring security 框架集成了Oauth2协议，下图是项目认证架构图：    </p>
<p><img src="/../../images/1558176649652.png" alt="1558176649652"></p>
<p>1、用户请求认证服务完成认证。 </p>
<p>2、认证服务下发用户身份令牌，拥有身份令牌表示身份合法。 </p>
<p>3、用户携带令牌请求资源服务，请求资源服务必先经过网关。 </p>
<p>4、网关校验用户身份令牌的合法，不合法表示用户没有登录，如果合法则放行继续访问。 </p>
<p>5、资源服务获取令牌，根据令牌完成授权。 </p>
<p>6、资源服务完成授权则响应资源信息。</p>
<h2 id="4-资源服务授权"><a href="#4-资源服务授权" class="headerlink" title="4 资源服务授权"></a>4 资源服务授权</h2><blockquote>
<p>具体实操了解</p>
</blockquote>
<h3 id="4-1-资源服务授权流程"><a href="#4-1-资源服务授权流程" class="headerlink" title="4.1 资源服务授权流程"></a>4.1 资源服务授权流程</h3><p>(1)传统授权流程</p>
<p><img src="/../../images/1562479275302.png" alt="1562479275302"></p>
<p>资源服务器授权流程如上图，客户端先去授权服务器申请令牌，申请令牌后，携带令牌访问资源服务器，资源服务器访问授权服务校验令牌的合法性，授权服务会返回校验结果，如果校验成功会返回用户信息给资源服务器，资源服务器如果接收到的校验结果通过了，则返回资源给客户端。</p>
<p>传统授权方法的问题是用户每次请求资源服务，资源服务都需要携带令牌访问认证服务去校验令牌的合法性，并根 据令牌获取用户的相关信息，性能低下。 </p>
<p>(2)公钥私钥授权流程</p>
<p><img src="/../../images/1562406193809.png" alt="1562406193809"></p>
<p>传统的授权模式性能低下，每次都需要请求授权服务校验令牌合法性，我们可以利用公钥私钥完成对令牌的加密，如果加密解密成功，则表示令牌合法，如果加密解密失败，则表示令牌无效不合法，合法则允许访问资源服务器的资源，解密失败，则不允许访问资源服务器资源。</p>
<p>上图的业务流程如下:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1、客户端请求认证服务申请令牌</span></span><br><span class="line"><span class="attr">2、认证服务生成令牌认证服务采用非对称加密算法，使用私钥生成令牌。</span></span><br><span class="line"><span class="attr">3、客户端携带令牌访问资源服务客户端在Http</span> <span class="string">header 中添加： Authorization：Bearer 令牌。</span></span><br><span class="line"><span class="attr">4、资源服务请求认证服务校验令牌的有效性资源服务接收到令牌，使用公钥校验令牌的合法性。</span></span><br><span class="line"><span class="attr">5、令牌有效，资源服务向客户端响应资源信息</span></span><br></pre></td></tr></table></figure>



<h3 id="5-2-认证服务"><a href="#5-2-认证服务" class="headerlink" title="5.2 认证服务"></a>5.2 认证服务</h3><h4 id="5-2-1-认证需求分析"><a href="#5-2-1-认证需求分析" class="headerlink" title="5.2.1 认证需求分析"></a>5.2.1 认证需求分析</h4><p>认证服务需要实现的功能如下： </p>
<p>1、登录接口 </p>
<p>前端post提交账号、密码等，用户身份校验通过，生成令牌，并将令牌写入cookie。 </p>
<p>2、退出接口 校验当前用户的身份为合法并且为已登录状态。 将令牌从cookie中删除。    </p>
<p><img src="/../../images/1558224020588.png" alt="1558224020588"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://gouguoqiang.github.io">ggq</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://gouguoqiang.github.io/2022/09/01/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E/%E7%94%A8%E6%88%B7%E7%99%BB%E9%99%86%20&amp;%20JWT%20&amp;%20Oauth2.0/">https://gouguoqiang.github.io/2022/09/01/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E/%E7%94%A8%E6%88%B7%E7%99%BB%E9%99%86%20&amp;%20JWT%20&amp;%20Oauth2.0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://gouguoqiang.github.io" target="_blank">ggq</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%95%86%E5%9F%8E/">商城</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/09/01/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E/%E6%80%BB%E7%BB%93/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">面试问题</div></div></a></div><div class="next-post pull-right"><a href="/2022/09/01/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E/%E7%A7%92%E6%9D%80%E6%A8%A1%E5%9D%97/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">秒杀模块</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/09/01/tuling/" title="图灵商城项目1"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-01</div><div class="title">图灵商城项目1</div></div></a></div><div><a href="/2022/09/01/tulingnote/" title="图灵商城项目2"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-01</div><div class="title">图灵商城项目2</div></div></a></div><div><a href="/2022/09/01/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E/0%E4%B8%9A%E5%8A%A1/" title="业务分析"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-01</div><div class="title">业务分析</div></div></a></div><div><a href="/2022/09/01/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E/gateway/" title="网关模块"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-01</div><div class="title">网关模块</div></div></a></div><div><a href="/2022/09/01/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E/mysql%E4%BC%98%E5%8C%96/" title="mysql优化实践"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-01</div><div class="title">mysql优化实践</div></div></a></div><div><a href="/2022/09/01/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E/nginx/" title="Nginx模块"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-01</div><div class="title">Nginx模块</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ggq</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">78</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">19</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">3 用户登录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E8%A1%A8%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">3.1 表结构介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E7%94%A8%E6%88%B7%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%88%9B%E5%BB%BA"><span class="toc-number">1.2.</span> <span class="toc-text">3.2 用户微服务创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E7%99%BB%E5%BD%95"><span class="toc-number">1.3.</span> <span class="toc-text">3.3 登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E7%BD%91%E5%85%B3%E5%85%B3%E8%81%94"><span class="toc-number">1.4.</span> <span class="toc-text">3.4 网关关联</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-JWT%E8%AE%B2%E8%A7%A3"><span class="toc-number">2.</span> <span class="toc-text">4 JWT讲解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">4.1 需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E4%BB%80%E4%B9%88%E6%98%AFJWT"><span class="toc-number">2.2.</span> <span class="toc-text">4.2 什么是JWT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-JWT%E7%9A%84%E6%9E%84%E6%88%90"><span class="toc-number">2.3.</span> <span class="toc-text">4.3 JWT的构成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-JJWT%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="toc-number">2.4.</span> <span class="toc-text">4.4 JJWT的介绍和使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-%E5%88%9B%E5%BB%BATOKEN"><span class="toc-number">2.4.1.</span> <span class="toc-text">4.4.1 创建TOKEN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-2-TOKEN%E8%A7%A3%E6%9E%90"><span class="toc-number">2.4.2.</span> <span class="toc-text">4.4.2 TOKEN解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-3-%E8%AE%BE%E7%BD%AE%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="toc-number">2.4.3.</span> <span class="toc-text">4.4.3 设置过期时间</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-3-1-token%E8%BF%87%E6%9C%9F%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.4.3.1.</span> <span class="toc-text">4.4.3.1 token过期设置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-3-2-%E8%A7%A3%E6%9E%90TOKEN"><span class="toc-number">2.4.3.2.</span> <span class="toc-text">4.4.3.2 解析TOKEN</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-4-%E8%87%AA%E5%AE%9A%E4%B9%89claims"><span class="toc-number">2.4.4.</span> <span class="toc-text">4.4.4 自定义claims</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E9%89%B4%E6%9D%83%E5%A4%84%E7%90%86"><span class="toc-number">2.5.</span> <span class="toc-text">4.5 鉴权处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">2.5.1.</span> <span class="toc-text">4.5.1 思路分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-2%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E7%AD%BE%E5%8F%91TOKEN"><span class="toc-number">2.5.2.</span> <span class="toc-text">4.5.2用户登录签发TOKEN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-3-%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E5%99%A8%E6%8B%A6%E6%88%AA%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86"><span class="toc-number">2.5.3.</span> <span class="toc-text">4.5.3 网关过滤器拦截请求处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-4-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">2.5.4.</span> <span class="toc-text">4.5.4 自定义全局过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-5-%E9%85%8D%E7%BD%AE%E8%BF%87%E6%BB%A4%E8%A7%84%E5%88%99"><span class="toc-number">2.5.5.</span> <span class="toc-text">4.5.5 配置过滤规则</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81"><span class="toc-number">2.6.</span> <span class="toc-text">4.6 会话保持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-1-%E7%99%BB%E5%BD%95%E5%B0%81%E8%A3%85Cookie"><span class="toc-number">2.6.1.</span> <span class="toc-text">4.6.1 登录封装Cookie</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-2-%E8%BF%87%E6%BB%A4%E5%99%A8%E8%8E%B7%E5%8F%96%E4%BB%A4%E7%89%8C%E6%95%B0%E6%8D%AE"><span class="toc-number">2.6.2.</span> <span class="toc-text">4.6.2 过滤器获取令牌数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-3-%E6%B7%BB%E5%8A%A0Header%E4%BF%A1%E6%81%AF"><span class="toc-number">2.6.3.</span> <span class="toc-text">4.6.3 添加Header信息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%AE%A4%E8%AF%81%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-number">3.</span> <span class="toc-text">2 认证技术方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-number">3.1.</span> <span class="toc-text">2.1 单点登录技术方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Oauth2-0"><span class="toc-number">4.</span> <span class="toc-text">Oauth2.0</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Spring-security-Oauth2%E8%AE%A4%E8%AF%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">4.1.</span> <span class="toc-text">2.3 Spring security Oauth2认证解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E6%8E%88%E6%9D%83"><span class="toc-number">5.</span> <span class="toc-text">4 资源服务授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B"><span class="toc-number">5.1.</span> <span class="toc-text">4.1 资源服务授权流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 认证服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-%E8%AE%A4%E8%AF%81%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">5.2.1.</span> <span class="toc-text">5.2.1 认证需求分析</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/02/01/%E7%AE%97%E6%B3%95/7%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/AcWing/" title="无题"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2023/02/01/%E7%AE%97%E6%B3%95/7%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/AcWing/" title="无题">无题</a><time datetime="2023-02-01T15:55:11.432Z" title="发表于 2023-02-01 23:55:11">2023-02-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/31/%E7%91%9E%E5%90%89%E5%A4%96%E5%8D%96/ruiji/" title="无题"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2023/01/31/%E7%91%9E%E5%90%89%E5%A4%96%E5%8D%96/ruiji/" title="无题">无题</a><time datetime="2023-01-31T14:50:49.607Z" title="发表于 2023-01-31 22:50:49">2023-01-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/21/%E7%AE%97%E6%B3%95/00pythonapi/" title="无题"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2022/12/21/%E7%AE%97%E6%B3%95/00pythonapi/" title="无题">无题</a><time datetime="2022-12-21T14:08:13.553Z" title="发表于 2022-12-21 22:08:13">2022-12-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/12/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E/0%E7%AE%80%E4%BB%8B/" title="无题"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2022/12/12/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E/0%E7%AE%80%E4%BB%8B/" title="无题">无题</a><time datetime="2022-12-12T15:06:58.895Z" title="发表于 2022-12-12 23:06:58">2022-12-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/19/22CloudNative/" title="无题"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2022/11/19/22CloudNative/" title="无题">无题</a><time datetime="2022-11-19T15:17:22.198Z" title="发表于 2022-11-19 23:17:22">2022-11-19</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By ggq</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>